---
title: "PhÃ¢n phá»‘i xÃ¡c suáº¥t"
format: html
execute: 
  echo: false
---

```{ojs}
import { createSlider, createButton, injectStyle } from "./_slider.js"
d3 = require("d3@7")
```

## Äá»‹nh nghÄ©a

PhÃ¢n phá»‘i xÃ¡c suáº¥t (probability distribution) lÃ  má»™t hÃ m sá»‘ (function) thá»ƒ hiá»‡n xÃ¡c suáº¥t cá»§a má»i biáº¿n cá»‘ (táº­p há»£p con) cá»§a khÃ´ng gian máº«u $\Omega$.

PhÃ¢n phá»‘i xÃ¡c suáº¥t báº¯t buá»™c pháº£i thá»a 3 Ä‘iá»u kiá»‡n sau:

-   $\mathbb{P}(\Omega) = 1$

-   $0 \leq \mathbb{P}(A) \leq 1$ vá»›i má»i biáº¿n cá»‘ $A$

-   Náº¿u cÃ¡c biáº¿n sá»‘ $A_1$, $A_2$, ..., $A_n$ xung kháº¯c, thÃ¬:

$$\mathbb{P}(A_1 \cup A_2 \cup \cdots \cup A_n) = \mathbb{P}(A_1) + \mathbb{P}(A_2) + \cdots + \mathbb{P}(A_n)$$

Má»—i biáº¿n ngáº«u nhiÃªn cÃ³ 1 phÃ¢n phá»‘i xÃ¡c suáº¥t. Do cÃ³ 2 loáº¡i biáº¿n rá»i ráº¡c vÃ  liÃªn tá»¥c, nÃªn phÃ¢n phá»‘i xÃ¡c suáº¥t cÅ©ng Ä‘Æ°á»£c phÃ¢n loáº¡i thÃ nh phÃ¢n phá»‘i rá»i ráº¡c vÃ  liÃªn tá»¥c tÆ°Æ¡ng á»©ng.

## CÃ¡c hÃ m phÃ¢n phá»‘i xÃ¡c suáº¥t

### HÃ m khá»‘i/máº­t Ä‘á»™ xÃ¡c suáº¥t

### 

### Joint distribution


## Moment

HÃ¬nh dáº¡ng cá»§a má»™t phÃ¢n phá»‘i Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh bá»Ÿi cÃ¡c giÃ¡ trá»‹ gá»i lÃ  moment. Thuáº­t ngá»¯ nÃ y Ä‘Æ°á»£c mÆ°á»£n tá»« váº­t lÃ½: mÃ´-men (hay mÃ´-men lá»±c) lÃ  Ä‘áº¡i lÆ°á»£ng Ä‘o kháº£ nÄƒng lÃ m quay cá»§a má»™t lá»±c quanh má»™t Ä‘iá»ƒm tá»±a.

Trong váº­t lÃ½, moment ($M$) Ä‘Æ°á»£c tÃ­nh báº±ng:

$$M = \underbrace{d}_{\text{Khoáº£ng cÃ¡ch Ä‘áº¿n Ä‘iá»ƒm tá»±a}} \times \underbrace{F}_{\text{Lá»±c tÃ¡c dá»¥ng}}$$

Trong thá»‘ng kÃª, hÃ£y tÆ°á»Ÿng tÆ°á»£ng trá»¥c sá»‘ nhÆ° má»™t cÃ¡i báº­p bÃªnh. Má»—i giÃ¡ trá»‹ $x$ lÃ  má»™t vá»‹ trÃ­ trÃªn thanh Ä‘Ã²n, vÃ  "sá»©c náº·ng" táº¡i Ä‘iá»ƒm Ä‘Ã³ chÃ­nh lÃ  xÃ¡c suáº¥t xáº£y ra cá»§a nÃ³. Khi Ä‘Ã³, ta tháº¥y sá»± tÆ°Æ¡ng Ä‘á»“ng vá»›i moment trong váº­t lÃ½:

- Lá»±c ($F$): TÆ°Æ¡ng á»©ng vá»›i XÃ¡c suáº¥t $f(x)$ (hoáº·c $\mathbb{P}(X=x)$). GiÃ¡ trá»‹ nÃ o cÃ³ xÃ¡c suáº¥t cÃ ng cao thÃ¬ "lá»±c" Ä‘Ã¨ xuá»‘ng cÃ ng náº·ng.

- Khoáº£ng cÃ¡ch Ä‘áº¿n Ä‘iá»ƒm tá»±a ($d$): TÆ°Æ¡ng á»©ng vá»›i $(x - a)$ lÃ  khoáº£ng cÃ¡ch tá»« giÃ¡ trá»‹ dá»¯ liá»‡u $x$ tá»›i má»™t Ä‘iá»ƒm má»‘c $a$ (vÃ­ dá»¥: gá»‘c 0 hoáº·c giÃ¡ trá»‹ trung bÃ¬nh).

Tá»•ng há»£p láº¡i, moment chÃ­nh lÃ  tá»•ng (hoáº·c tÃ­ch phÃ¢n) cá»§a cÃ¡c tÃ­ch sá»‘ giá»¯a khoáº£ng cÃ¡ch vÃ  xÃ¡c suáº¥t. Trong ngÃ´n ngá»¯ thá»‘ng kÃª, phÃ©p tá»•ng cÃ³ trá»ng sá»‘ nÃ y chÃ­nh lÃ  Ká»³ vá»ng ($E$).

CÃ´ng thá»©c moment báº­c $n$ quanh Ä‘iá»ƒm $a$ Ä‘Æ°á»£c viáº¿t lÃ :

$$E[(X - a)^n] = \begin{cases} \sum (x_i - a)^n \mathbb{P}(x_i) & \text{(Rá»i ráº¡c)} \\ \int_{-\infty}^{\infty} (x - a)^n f(x) dx & \text{(LiÃªn tá»¥c)} \end{cases}$$

::: {.callout-important}
KÃ½ hiá»‡u $E[g(X)]$ chÃ­nh lÃ  Ä‘á»‹nh nghÄ©a toÃ¡n há»c cá»§a viá»‡c láº¥y giÃ¡ trá»‹ $g(X)$ nhÃ¢n vá»›i xÃ¡c suáº¥t rá»“i cá»™ng láº¡i. Báº¥t cá»© khi nÃ o tháº¥y "Láº¥y má»™t giÃ¡ trá»‹, nhÃ¢n vá»›i xÃ¡c suáº¥t cá»§a nÃ³, rá»“i cá»™ng háº¿t láº¡i", thÃ¬ Ä‘Ã³ chÃ­nh lÃ  Ká»³ vá»ng ($E$).
:::

Má»™t cÃ¡ch tá»•ng quÃ¡t, vá»›i má»™t biáº¿n ngáº«u nhiÃªn $X$, moment báº­c $n$ quanh Ä‘iá»ƒm $a$ (the $n$-th moment about $a$) lÃ :

$$E[(X - a)^n]$$

CÃ³ 2 loáº¡i moment:

-   Moment gá»‘c (raw moment, láº¥y má»‘c lÃ  Ä‘iá»ƒm 0): khi $a = 0$, moment lÃ  $E[X^n]$.
-   Moment táº­p trung (central moment, láº¥y má»‘c lÃ  giÃ¡ trá»‹ trung bÃ¬nh): khi $a = E[X]$, moment lÃ  $E[(X - E[X])^n]$.

Báº­c cá»§a moment cÃ³ thá»ƒ tá»« 0 Ä‘áº¿n $\infty$. ChÃºng ta thÆ°á»ng quan tÃ¢m tá»›i 4 loáº¡i moment sau:

| Loáº¡i moment | KÃ­ hiá»‡u | TÃªn thÆ°á»ng gá»i | Ã nghÄ©a |
|----|----|----|----|
| Gá»‘c báº­c 1 | $E[X]$ | Ká»³ vá»ng (Mean) | Vá»‹ trÃ­ (tÃ¢m cá»§a phÃ¢n phá»‘i) |
| Táº­p trung báº­c 2 | $E[(X - E[X])^2]$ | PhÆ°Æ¡ng sai (Variance) | Äá»™ phÃ¢n tÃ¡n (dá»¯ liá»‡u biáº¿n Ä‘á»™ng tháº¿ nÃ o) |
| Táº­p trung báº­c 3 | $E[(X - E[X])^3]$ | Äá»™ lá»‡ch (Skewness)\* | TÃ­nh báº¥t Ä‘á»‘i xá»©ng (bÃªn nÃ o cÃ³ Ä‘uÃ´i dÃ i hÆ¡n) |
| Táº­p trung báº­c 4 | $E[(X - E[X])^4]$ | Äá»™ nhá»n (Kurtosis)\* | Äá»™ dÃ y cá»§a Ä‘uÃ´i |

*Äá»™ lá»‡ch vÃ  Äá»™ nhá»n thÆ°á»ng Ä‘Æ°á»£c chuáº©n hÃ³a (standardised) báº±ng cÃ¡ch chia cho Ä‘á»™ lá»‡ch chuáº©n $\sigma$, Ã½ nghÄ©a lÃ  gáº¥p bao nhiÃªu láº§n Ä‘á»™ lá»‡ch chuáº©n.

```{ojs}
viewof moment_seesaw = {

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONFIG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const W = 780, H = 470;
  const COL = {
    beam: "#FFB300", beamStroke: "#F9A825",
    pivot: "#F4511E", pivotStroke: "#D84315",
    block: "#EF5350", blockStroke: "#C62828",
    blockAlt: "#FF7043", blockAltStroke: "#E64A19",
    dist: "#1565C0",
    force: "#00897B",
    moment: "#7B1FA2",
    ref: "#E91E63",
    bg: "#fff", sub: "#78909C", txt: "#263238",
    snap: "#43A047",
  };

  // Distribution presets
  const distributions = {
    "Äá»‘i xá»©ng (Symmetric)": [
      { x: 1, freq: 1 }, { x: 2, freq: 3 }, { x: 3, freq: 5 },
      { x: 4, freq: 7 }, { x: 5, freq: 5 }, { x: 6, freq: 3 }, { x: 7, freq: 1 },
    ],
    "Lá»‡ch pháº£i (Right-skewed)": [
      { x: 1, freq: 7 }, { x: 2, freq: 5 }, { x: 3, freq: 4 },
      { x: 4, freq: 3 }, { x: 5, freq: 2 }, { x: 7, freq: 1 },
    ],
    "Lá»‡ch trÃ¡i (Left-skewed)": [
      { x: 1, freq: 1 }, { x: 3, freq: 2 }, { x: 4, freq: 3 },
      { x: 5, freq: 4 }, { x: 6, freq: 5 }, { x: 7, freq: 7 },
    ],
    "Äá»u (Uniform)": [
      { x: 1, freq: 4 }, { x: 2, freq: 4 }, { x: 3, freq: 4 },
      { x: 4, freq: 4 }, { x: 5, freq: 4 }, { x: 6, freq: 4 },
    ],
    "Hai Ä‘á»‰nh (Bimodal)": [
      { x: 1, freq: 6 }, { x: 2, freq: 4 }, { x: 3, freq: 1 },
      { x: 5, freq: 1 }, { x: 6, freq: 4 }, { x: 7, freq: 6 },
    ],
    "ÄuÃ´i náº·ng (Heavy-tailed)": [
      { x: 0, freq: 2 }, { x: 2, freq: 1 }, { x: 3, freq: 3 },
      { x: 4, freq: 6 }, { x: 5, freq: 3 }, { x: 6, freq: 1 }, { x: 8, freq: 2 },
    ],
  };

  let dataPoints = distributions["Lá»‡ch pháº£i (Right-skewed)"].map(d => ({ ...d }));

  const outer = document.createElement("div");
  outer.style.cssText = `display:flex;flex-direction:column;align-items:center;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    width:100%;max-width:820px;margin:0 auto;`;
  outer.appendChild(injectStyle());

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let useCenter = false;
  let momentOrder = 1;
  let pivotValue = 0;
  let isDragging = false;
  let activeDist = "Lá»‡ch pháº£i (Right-skewed)";

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONTROLS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Distribution selector
  const distRow = document.createElement("div");
  distRow.style.cssText = "display:flex;gap:6px;width:100%;margin-bottom:10px;flex-wrap:wrap;align-items:center;";
  const distLabel = document.createElement("span");
  distLabel.style.cssText = `font-size:13px;font-weight:700;color:${COL.sub};margin-right:4px;`;
  distLabel.textContent = "Dá»¯ liá»‡u:";
  distRow.appendChild(distLabel);

  const distBtns = {};
  Object.keys(distributions).forEach(name => {
    const b = document.createElement("button");
    b.style.cssText = `padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600;
      font-family:inherit;cursor:pointer;transition:all 0.15s;border:1.5px solid #B0BEC5;
      background:#fff;color:${COL.txt};`;
    b.textContent = name;
    b.addEventListener("click", () => {
      activeDist = name;
      dataPoints = distributions[name].map(d => ({ ...d }));
      if (useCenter) pivotValue = computeMean();
      else pivotValue = 0;
      update();
    });
    distBtns[name] = b;
    distRow.appendChild(b);
  });
  outer.appendChild(distRow);

  function styleDistBtn(btn, active) {
    btn.style.background = active ? COL.txt : "#fff";
    btn.style.color = active ? "#fff" : COL.txt;
    btn.style.borderColor = active ? COL.txt : "#B0BEC5";
  }

  // Mode row
  const modeRow = document.createElement("div");
  modeRow.style.cssText = "display:flex;gap:10px;width:100%;margin-bottom:8px;";

  function mkModeBtn(text) {
    const b = document.createElement("button");
    b.style.cssText = `flex:1;padding:10px 14px;border-radius:8px;font-size:12px;font-weight:700;
      font-family:inherit;cursor:pointer;transition:all 0.15s;border:2px solid ${COL.ref};
      background:#fff;color:${COL.ref};`;
    b.textContent = text;
    return b;
  }
  const btnRaw = mkModeBtn("a = 0  (Moment gá»‘c)");
  const btnCentral = mkModeBtn("a = Î¼  (Moment táº­p trung)");
  modeRow.appendChild(btnRaw);
  modeRow.appendChild(btnCentral);
  outer.appendChild(modeRow);

  function styleModeBtn(btn, active) {
    btn.style.background = active ? COL.ref : "#fff";
    btn.style.color = active ? "#fff" : COL.ref;
    btn.style.borderColor = COL.ref;
  }

  // Order tabs (always shown)
  const orderRow = document.createElement("div");
  orderRow.style.cssText = "display:flex;gap:8px;width:100%;margin-bottom:8px;align-items:center;";
  const orderLabel = document.createElement("span");
  orderLabel.style.cssText = `font-size:13px;font-weight:700;color:${COL.sub};margin-right:4px;`;
  orderLabel.textContent = "Báº­c (Order):";
  orderRow.appendChild(orderLabel);

  const orderBtns = [];
  const orderDefs = [
    { n: 1, label: "n = 1" },
    { n: 2, label: "n = 2" },
    { n: 3, label: "n = 3" },
    { n: 4, label: "n = 4" },
  ];
  orderDefs.forEach(od => {
    const b = document.createElement("button");
    b.style.cssText = `padding:8px 14px;border-radius:8px;font-size:12px;font-weight:700;
      font-family:inherit;cursor:pointer;transition:all 0.15s;border:2px solid ${COL.moment};
      background:#fff;color:${COL.moment};`;
    b.textContent = od.label;
    b.addEventListener("click", () => {
      if (!useCenter && od.n > 1) return; // raw mode: only n=1
      if (useCenter && od.n < 2) return;  // central mode: only n>=2
      momentOrder = od.n;
      update();
    });
    orderBtns.push({ el: b, n: od.n });
    orderRow.appendChild(b);
  });
  outer.appendChild(orderRow);

  function styleOrderBtn(btn, n, active, enabled) {
    if (!enabled) {
      btn.style.background = "#f5f5f5";
      btn.style.color = "#ccc";
      btn.style.borderColor = "#e0e0e0";
      btn.style.cursor = "not-allowed";
    } else if (active) {
      btn.style.background = COL.moment;
      btn.style.color = "#fff";
      btn.style.borderColor = COL.moment;
      btn.style.cursor = "pointer";
    } else {
      btn.style.background = "#fff";
      btn.style.color = COL.moment;
      btn.style.borderColor = COL.moment;
      btn.style.cursor = "pointer";
    }
  }

  // Mode events
  btnRaw.addEventListener("click", () => {
    useCenter = false; pivotValue = 0; momentOrder = 1;
    update();
  });
  btnCentral.addEventListener("click", () => {
    useCenter = true; pivotValue = computeMean();
    if (momentOrder < 2) momentOrder = 2;
    update();
  });

  // Drag hint
  const hintRow = document.createElement("div");
  hintRow.style.cssText = `font-size:12px;color:${COL.sub};margin-bottom:6px;width:100%;text-align:center;font-style:italic;`;
  hintRow.textContent = "ğŸ’¡ KÃ©o chÃ¢n Ä‘áº¿ cá»§a báº­p bÃªnh Ä‘á»ƒ thay Ä‘á»•i Ä‘iá»ƒm má»‘c";
  outer.appendChild(hintRow);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SVG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const svg = d3.create("svg")
    .attr("viewBox", [0, 0, W, H])
    .style("width", "100%").style("max-width", W + "px")
    .style("background", COL.bg);

  const defs = svg.append("defs");

  // Arrow markers
  function addArrow(id, color) {
    defs.append("marker").attr("id", id)
      .attr("viewBox", "0 0 10 7").attr("refX", 9).attr("refY", 3.5)
      .attr("markerWidth", 10).attr("markerHeight", 7).attr("orient", "auto")
      .append("polygon").attr("points", "0 0.5, 9 3.5, 0 6.5").attr("fill", color);
  }
  addArrow("arrDistR", COL.dist);
  addArrow("arrForce", COL.force);
  defs.append("marker").attr("id", "arrDistL")
    .attr("viewBox", "0 0 10 7").attr("refX", 1).attr("refY", 3.5)
    .attr("markerWidth", 10).attr("markerHeight", 7).attr("orient", "auto")
    .append("polygon").attr("points", "10 0.5, 1 3.5, 10 6.5").attr("fill", COL.dist);

  // â”€â”€ LAYOUT â”€â”€
  const beamCX = W / 2, beamCY = 290;
  const beamHalfW = 330, beamH = 16;
  const blockSize = 22;
  const pivotH = 70, pivotW = 60;

  // â”€â”€ FORMULA (top) â”€â”€
  const formulaText = svg.append("text")
    .attr("x", W / 2).attr("y", 26)
    .attr("text-anchor", "middle").attr("font-size", 18).attr("font-weight", 700)
    .attr("font-family", "'SF Mono',SFMono-Regular,Menlo,monospace");
  const formulaSub = svg.append("text")
    .attr("x", W / 2).attr("y", 50)
    .attr("text-anchor", "middle").attr("font-size", 14).attr("fill", COL.sub);

  // â”€â”€ BALANCE BADGE (top right) â”€â”€
  const balanceG = svg.append("g").style("display", "none");
  const balanceBg = balanceG.append("rect").attr("rx", 10).attr("fill", COL.snap);
  const balanceTxt = balanceG.append("text").attr("text-anchor", "middle").attr("dominant-baseline", "middle")
    .attr("fill", "#fff").attr("font-size", 14).attr("font-weight", 700).text("CÃ¢n báº±ng!");

  // â”€â”€ SCENE GROUP (rotates) â”€â”€
  const sceneG = svg.append("g");

  // Beam
  sceneG.append("rect")
    .attr("x", beamCX - beamHalfW).attr("y", beamCY - beamH / 2)
    .attr("width", beamHalfW * 2).attr("height", beamH)
    .attr("rx", 5).attr("fill", COL.beam).attr("stroke", COL.beamStroke).attr("stroke-width", 1.5);

  const tickG = sceneG.append("g");
  const blocksG = sceneG.append("g");

  // â”€â”€ PIVOT â”€â”€
  const pivotTriG = svg.append("g").style("cursor", "ew-resize");
  pivotTriG.append("polygon")
    .attr("points", `0,0 ${-pivotW / 2 - 12},${pivotH + 12} ${pivotW / 2 + 12},${pivotH + 12}`)
    .attr("fill", "transparent");
  pivotTriG.append("polygon")
    .attr("class", "pivot-tri")
    .attr("points", `0,4 ${-pivotW / 2},${pivotH} ${pivotW / 2},${pivotH}`)
    .attr("fill", COL.pivot).attr("stroke", COL.pivotStroke).attr("stroke-width", 1.5).attr("stroke-linejoin", "round");
  pivotTriG.append("circle").attr("cx", 0).attr("cy", 8).attr("r", 8)
    .attr("fill", "#fff").attr("stroke", COL.pivotStroke).attr("stroke-width", 1.5);
  pivotTriG.append("circle").attr("cx", 0).attr("cy", 8).attr("r", 3.5).attr("fill", COL.pivot);

  // â”€â”€ ANNOTATIONS â”€â”€
  const annoG = svg.append("g");

  // Ref line & pill
  const refLine = annoG.append("line").attr("stroke", COL.ref).attr("stroke-width", 1.5).attr("stroke-dasharray", "5,3");
  const refPill = annoG.append("g");
  const refPillBg = refPill.append("rect").attr("rx", 10).attr("fill", COL.ref);
  const refPillTxt = refPill.append("text").attr("text-anchor", "middle").attr("dominant-baseline", "middle")
    .attr("fill", "#fff").attr("font-size", 14).attr("font-weight", 700);

  // Hover annotations
  const distAnnoG = annoG.append("g").style("display", "none");
  const distLine1 = distAnnoG.append("line").attr("stroke", COL.dist).attr("stroke-width", 2)
    .attr("marker-start", "url(#arrDistL)").attr("marker-end", "url(#arrDistR)");
  const distPill = distAnnoG.append("g");
  const distPillBg = distPill.append("rect").attr("rx", 8).attr("fill", COL.dist);
  const distPillTxt = distPill.append("text").attr("text-anchor", "middle").attr("dominant-baseline", "middle")
    .attr("fill", "#fff").attr("font-size", 12).attr("font-weight", 700)
    .attr("font-family", "'SF Mono',monospace");
  const forceArrow = distAnnoG.append("line").attr("stroke", COL.force).attr("stroke-width", 2.5)
    .attr("marker-end", "url(#arrForce)");
  const forcePill = distAnnoG.append("g");
  const forcePillBg = forcePill.append("rect").attr("rx", 8).attr("fill", COL.force);
  const forcePillTxt = forcePill.append("text").attr("text-anchor", "middle").attr("dominant-baseline", "middle")
    .attr("fill", "#fff").attr("font-size", 12).attr("font-weight", 700);

  // â”€â”€ CONTRIBUTION BARS â”€â”€
  const contribG = svg.append("g");

  outer.appendChild(svg.node());

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // X-SCALE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let xScale;
  function buildXScale() {
    const allX = dataPoints.map(d => d.x);
    const xMin = Math.min(0, ...allX) - 1;
    const xMax = Math.max(...allX) + 1;
    xScale = d3.scaleLinear()
      .domain([xMin, xMax])
      .range([beamCX - beamHalfW + 24, beamCX + beamHalfW - 24]);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // COMPUTE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function computeMean() {
    let sumF = 0, sumFX = 0;
    for (const d of dataPoints) { sumF += d.freq; sumFX += d.freq * d.x; }
    return sumF > 0 ? sumFX / sumF : 0;
  }
  function computeMoment(n, center) {
    let sumF = 0, sumM = 0;
    for (const d of dataPoints) { sumF += d.freq; sumM += d.freq * Math.pow(d.x - center, n); }
    return sumF > 0 ? sumM / sumF : 0;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HOVER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function showAnnotation(d) {
    const n = momentOrder;
    const center = pivotValue;
    const refPx = xScale(center);
    const hlPx = xScale(d.x);
    const topOfStack = beamCY - beamH / 2 - d.freq * (blockSize + 2) - 2;
    const distY = topOfStack - 14;

    if (Math.abs(hlPx - refPx) > 20) {
      distLine1.attr("x1", refPx).attr("y1", distY).attr("x2", hlPx).attr("y2", distY).style("display", "");
      const distMidX = (refPx + hlPx) / 2;
      const distVal = (d.x - center);
      const distTxt = n > 1
        ? `(${distVal.toFixed(1)})${["", "", "\u00B2", "\u00B3", "\u2074"][n]}`
        : `${distVal.toFixed(1)}`;
      distPillTxt.text(`d = ${distTxt}`);
      const dtw = distTxt.length * 7 + 50;
      distPillBg.attr("x", distMidX - dtw / 2).attr("y", distY - 22).attr("width", dtw).attr("height", 20);
      distPillTxt.attr("x", distMidX).attr("y", distY - 12);
      distPill.style("display", "");
    } else {
      distLine1.style("display", "none");
      distPill.style("display", "none");
    }

    const forceArrowX = hlPx + blockSize / 2 + 10;
    const forceY1 = topOfStack + 4;
    const forceLen = 16 + d.freq * 10;
    forceArrow.attr("x1", forceArrowX).attr("y1", forceY1)
      .attr("x2", forceArrowX).attr("y2", forceY1 + forceLen).style("display", "");
    forcePillTxt.text(`f = ${d.freq}`);
    const ftw = 58;
    forcePillBg.attr("x", forceArrowX - ftw / 2).attr("y", forceY1 + forceLen + 3).attr("width", ftw).attr("height", 20);
    forcePillTxt.attr("x", forceArrowX).attr("y", forceY1 + forceLen + 13);
    forcePill.style("display", "");
    distAnnoG.style("display", "");
  }

  function hideAnnotation() {
    distAnnoG.style("display", "none");
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DRAG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const pivotDrag = d3.drag()
    .on("start", function () {
      isDragging = true;
      pivotTriG.select(".pivot-tri").attr("fill", "#FF8A65");
    })
    .on("drag", function (event) {
      const px = Math.max(beamCX - beamHalfW + 24, Math.min(beamCX + beamHalfW - 24, event.x));
      pivotValue = Math.round(xScale.invert(px) * 10) / 10;
      update(true);
    })
    .on("end", function () {
      isDragging = false;
      pivotTriG.select(".pivot-tri").attr("fill", COL.pivot);
      const mean = computeMean();
      if (Math.abs(pivotValue - mean) < 0.2) {
        pivotValue = mean; useCenter = true;
        if (momentOrder < 2) momentOrder = 2;
      } else if (Math.abs(pivotValue) < 0.2) {
        pivotValue = 0; useCenter = false; momentOrder = 1;
      }
      update();
    });
  pivotTriG.call(pivotDrag);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UPDATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function update(noTransition) {
    const n = momentOrder;
    const mean = computeMean();
    const center = pivotValue;
    const momentVal = computeMoment(n, center);

    const isExactlyRaw = Math.abs(center) < 0.001;
    const isExactlyCentral = Math.abs(center - mean) < 0.001;

    // Controls
    styleModeBtn(btnRaw, !useCenter);
    styleModeBtn(btnCentral, useCenter);
    Object.entries(distBtns).forEach(([name, btn]) => styleDistBtn(btn, name === activeDist));

    // Order buttons: enable/disable based on mode
    orderBtns.forEach(ob => {
      const enabled = useCenter ? ob.n >= 2 : ob.n === 1;
      styleOrderBtn(ob.el, ob.n, ob.n === n, enabled);
    });

    buildXScale();
    const allX = dataPoints.map(d => d.x);
    const xMin = Math.min(0, ...allX) - 1;
    const xMax = Math.max(...allX) + 1;

    // Pivot
    const pivotPx = xScale(center);
    if (noTransition) {
      pivotTriG.attr("transform", `translate(${pivotPx}, ${beamCY})`);
    } else {
      pivotTriG.transition().duration(500).ease(d3.easeCubicOut)
        .attr("transform", `translate(${pivotPx}, ${beamCY})`);
    }

    // Tilt
    const m1 = computeMoment(1, center);
    const tiltDeg = Math.max(-12, Math.min(12, m1 * 4));
    if (noTransition) {
      sceneG.attr("transform", `rotate(${tiltDeg}, ${pivotPx}, ${beamCY})`);
    } else {
      sceneG.transition().duration(500).ease(d3.easeCubicOut)
        .attr("transform", `rotate(${tiltDeg}, ${pivotPx}, ${beamCY})`);
    }

    // Balance badge â€” top right
    const isBalanced = Math.abs(m1) < 0.05;
    if (isBalanced) {
      const bw = 110, bh = 26;
      balanceBg.attr("x", W - bw - 14).attr("y", 12).attr("width", bw).attr("height", bh);
      balanceTxt.attr("x", W - bw / 2 - 14).attr("y", 25);
      balanceG.style("display", "");
    } else {
      balanceG.style("display", "none");
    }

    // Ticks
    tickG.selectAll("*").remove();
    for (let x = Math.ceil(xMin); x <= Math.floor(xMax); x++) {
      const tx = xScale(x);
      tickG.append("line").attr("x1", tx).attr("x2", tx)
        .attr("y1", beamCY - beamH / 2 - 4).attr("y2", beamCY - beamH / 2)
        .attr("stroke", COL.beamStroke).attr("stroke-width", 1.2);
      tickG.append("text").attr("x", tx).attr("y", beamCY + beamH / 2 + 14)
        .attr("text-anchor", "middle").attr("font-size", 12).attr("fill", COL.sub)
        .attr("font-family", "'SF Mono',monospace").text(x);
    }

    // Blocks
    blocksG.selectAll("*").remove();
    dataPoints.forEach((d) => {
      const bx = xScale(d.x);
      for (let f = 0; f < d.freq; f++) {
        const by = beamCY - beamH / 2 - (f + 1) * (blockSize + 2) - 2;
        const g = blocksG.append("g").style("cursor", "pointer");
        g.append("rect")
          .attr("x", bx - blockSize / 2).attr("y", by)
          .attr("width", blockSize).attr("height", blockSize)
          .attr("rx", 4)
          .attr("fill", COL.blockAlt).attr("stroke", COL.blockAltStroke).attr("stroke-width", 1.2);
        g.on("mouseenter", () => {
          blocksG.selectAll("g").each(function () {
            const rect = d3.select(this).select("rect");
            const rx = +rect.attr("x") + blockSize / 2;
            if (Math.abs(rx - bx) < 1) {
              rect.attr("fill", COL.block).attr("stroke", COL.blockStroke);
            }
          });
          showAnnotation(d);
        });
        g.on("mouseleave", () => {
          blocksG.selectAll("g").each(function () {
            const rect = d3.select(this).select("rect");
            rect.attr("fill", COL.blockAlt).attr("stroke", COL.blockAltStroke);
          });
          hideAnnotation();
        });
      }
    });

    // Ref line & pill
    const refPx = xScale(center);
    const refTopY = 78;
    refLine.attr("x1", refPx).attr("x2", refPx).attr("y1", refTopY).attr("y2", beamCY + 6);
    let refTxt = isExactlyCentral ? `a = Î¼ = ${mean.toFixed(2)}`
      : isExactlyRaw ? "c = 0"
      : `a = ${center.toFixed(2)}`;
    refPillTxt.text(refTxt);
    const refTW = refTxt.length * 8 + 20;
    refPillBg.attr("x", refPx - refTW / 2).attr("y", refTopY - 14).attr("width", refTW).attr("height", 26);
    refPillTxt.attr("x", refPx).attr("y", refTopY - 1);

    hideAnnotation();

    // Contribution bars (n >= 2)
    contribG.selectAll("*").remove();
    if (n >= 2) {
      const contributions = dataPoints.filter(d => d.freq > 0).map(d => {
        const dist = d.x - center;
        return { x: d.x, val: d.freq * Math.pow(dist, n) };
      });
      const maxAbs = Math.max(1e-9, ...contributions.map(c => Math.abs(c.val)));
      const barMaxH = 45;
      const barW = 18;
      const barBaseY = beamCY + pivotH + 42;
      const supN = ["", "\u00B9", "\u00B2", "\u00B3", "\u2074"][n];

      contribG.append("line")
        .attr("x1", xScale(xMin + 0.3)).attr("x2", xScale(xMax - 0.3))
        .attr("y1", barBaseY).attr("y2", barBaseY)
        .attr("stroke", "#CFD8DC").attr("stroke-width", 1);


      contributions.forEach(c => {
        const bx = xScale(c.x);
        const h = (Math.abs(c.val) / maxAbs) * barMaxH;
        const isPos = c.val >= 0;
        const barColor = n === 3 ? (isPos ? "#42A5F5" : "#EF5350") : COL.moment;

        contribG.append("rect")
          .attr("x", bx - barW / 2)
          .attr("y", isPos ? barBaseY - h : barBaseY)
          .attr("width", barW).attr("height", Math.max(1, h))
          .attr("rx", 3).attr("fill", barColor).attr("opacity", 0.75);

        contribG.append("text")
          .attr("x", bx).attr("y", isPos ? barBaseY - h - 4 : barBaseY + h + 11)
          .attr("text-anchor", "middle").attr("font-size", 9).attr("fill", COL.sub)
          .attr("font-family", "'SF Mono',monospace")
          .text(c.val.toFixed(1));
      });
    }

    // Formula
    const supN = ["", "\u00B9", "\u00B2", "\u00B3", "\u2074"][n];
    const typeName = isExactlyCentral ? "Moment táº­p trung" : isExactlyRaw ? "Moment gá»‘c" : "Moment";
    const momentNames = {
      1: { c: "Trung bÃ¬nh (Mean)", r: "Trung bÃ¬nh (Mean)" },
      2: { c: "PhÆ°Æ¡ng sai (Variance)", r: "" },
      3: { c: "Äá»™ lá»‡ch (Skewness)", r: "" },
      4: { c: "Äá»™ nhá»n (Kurtosis)", r: "" }
    };
    const mName = isExactlyCentral ? (momentNames[n]?.c || "") : (momentNames[n]?.r || "");

    formulaText.html("");
    formulaText.append("tspan").attr("fill", COL.moment).text(`${typeName} (n=${n})`);
    if (mName) formulaText.append("tspan").attr("fill", COL.sub).attr("font-size", 15).text(`  â€”  ${mName}`);

    formulaSub.html("");
    formulaSub.append("tspan").attr("fill", COL.moment).text("Î¼");
    formulaSub.append("tspan").attr("fill", COL.moment).attr("font-size", 10).attr("dy", 3).text(n);
    formulaSub.append("tspan").attr("dy", -3).attr("fill", COL.txt).text(" = Î£ ");
    formulaSub.append("tspan").attr("fill", COL.force).text("fáµ¢");
    formulaSub.append("tspan").attr("fill", COL.txt).text("Â·");
    formulaSub.append("tspan").attr("fill", COL.dist).text("(xáµ¢âˆ’c)");
    formulaSub.append("tspan").attr("fill", COL.moment).attr("font-size", 10).attr("dy", -4).text(n);
    formulaSub.append("tspan").attr("dy", 4).attr("fill", COL.txt).text(" / N");
    formulaSub.append("tspan").attr("fill", COL.moment).attr("font-weight", 700).text(` = ${momentVal.toFixed(4)}`);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update();
  invalidation.then(() => {});
  outer.value = {};
  return outer;
}
```

### Moment gá»‘c báº­c 1

Cho biáº¿t vá»‹ trÃ­ trá»ng tÃ¢m cá»§a phÃ¢n phá»‘i náº±m á»Ÿ Ä‘Ã¢u so vá»›i Ä‘iá»ƒm 0.

$$E[X] = \frac{\sum^N_{i = 1}x_i}{N} = \sum^N_{i = 1}x_i \mathbb{P}(x_i)$$

### Moment táº­p trung báº­c 2

Cho biáº¿t khoáº£ng cÃ¡ch cá»§a tá»«ng giÃ¡ trá»‹ trong phÃ¢n phá»‘i so vá»›i giÃ¡ trá»‹ trung bÃ¬nh. PhÃ©p bÃ¬nh phÆ°Æ¡ng giÃºp ngÄƒn cháº·n cÃ¡c Ä‘á»™ lá»‡ch Ã¢m vÃ  dÆ°Æ¡ng triá»‡t tiÃªu láº«n nhau.

$$E[(X - E[X])^2] = E[X^2] - (E[X])^2$$

### Moment táº­p trung báº­c 3

ThÆ°á»ng Ä‘Æ°á»£c gá»i lÃ  Äá»™ lá»‡ch (Skewness). NÃ³ pháº£n Ã¡nh sá»± khÃ´ng Ä‘á»‘i xá»©ng.

$$E\left[\left(\frac{X - E[X]}{\sigma}\right)^3\right]$$

LÅ©y thá»«a báº­c 3 giá»¯ nguyÃªn dáº¥u (sá»‘ Ã¢m mÅ© 3 váº«n lÃ  Ã¢m)

### Moment táº­p trung báº­c 4

ThÆ°á»ng Ä‘Æ°á»£c gá»i lÃ  Äá»™ nhá»n (Kurtosis). TÃªn gá»i nÃ y báº¯t nguá»“n tá»« tiáº¿ng Hy Láº¡p: ÎºÏ…ÏÏ„ÏŒÏ‚ - kyrtos, nghÄ©a lÃ  "cong, vÃ²m".

$$E\left[\left(\frac{X - E[X]}{\sigma}\right)^4\right]$$

LÅ©y thá»«a báº­c 4 lÃ m cho nhá»¯ng giÃ¡ trá»‹ nhá» (gáº§n trung bÃ¬nh) trá»Ÿ nÃªn siÃªu nhá», vÃ  nhá»¯ng giÃ¡ trá»‹ lá»›n (xa trung bÃ¬nh - outliers) trá»Ÿ nÃªn lá»›n hÆ¡n nhiá»u láº§n. Moment nÃ y cÃ ng lá»›n thÃ¬ Ä‘uÃ´i cá»§a phÃ¢n phá»‘i cÃ ng dÃ y, nghÄ©a lÃ  xÃ¡c suáº¥t xáº£y ra cÃ¡c sá»± kiá»‡n cá»±c Ä‘oan cÃ ng lá»›n.

Leptokurtic (tiá»n tá»‘ lepto- nghÄ©a lÃ  nhá», máº£nh kháº£nh): Ä‘á»™ nhá»n > 3.

## Táº¡i sao láº¡i há»c moment?

DÃ¹ng method of moments Ä‘á»ƒ xÃ¡c Ä‘á»‹nh Ä‘iá»ƒm báº¯t Ä‘áº§u cá»§a tham sá»‘ Æ°á»›c lÆ°á»£ng báº±ng MLE [@bolker2008]. Sáº½ Ã¡p dá»¥ng á»Ÿ bÃ i likelihood.

Estimate

Estimand

Estimator
