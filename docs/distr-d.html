<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Phân phối rời rạc – Statistics for babies</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./distr-shape.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-832c273f0af7a47d06e59912ec7b3523.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-N2T5TFNFY7"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-N2T5TFNFY7', { 'anonymize_ip': true});
</script>
<script type="module" src="site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./distr-d.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Phân phối rời rạc</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Statistics for babies</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prob.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Xác suất</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bayes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bayesian</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distr-shape.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Hình dạng phân phối</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distr-d.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Phân phối rời rạc</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tài liệu tham khảo</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#phép-thử-bernoulli-bernoulli-trial-hay-binomial-trial" id="toc-phép-thử-bernoulli-bernoulli-trial-hay-binomial-trial" class="nav-link active" data-scroll-target="#phép-thử-bernoulli-bernoulli-trial-hay-binomial-trial"><span class="header-section-number">4.1</span> Phép thử Bernoulli (Bernoulli trial, hay binomial trial)</a></li>
  <li><a href="#đếm-số-lần-thành-công" id="toc-đếm-số-lần-thành-công" class="nav-link" data-scroll-target="#đếm-số-lần-thành-công"><span class="header-section-number">4.2</span> Đếm số lần thành công</a>
  <ul class="collapse">
  <li><a href="#phân-phối-nhị-nhức-binomial-distribution" id="toc-phân-phối-nhị-nhức-binomial-distribution" class="nav-link" data-scroll-target="#phân-phối-nhị-nhức-binomial-distribution"><span class="header-section-number">4.2.1</span> Phân phối nhị nhức (binomial distribution)</a></li>
  <li><a href="#phân-phối-siêu-bội-hypergeometric-distribution" id="toc-phân-phối-siêu-bội-hypergeometric-distribution" class="nav-link" data-scroll-target="#phân-phối-siêu-bội-hypergeometric-distribution"><span class="header-section-number">4.2.2</span> Phân phối siêu bội (hypergeometric distribution)</a></li>
  </ul></li>
  <li><a href="#đếm-số-lần-thử" id="toc-đếm-số-lần-thử" class="nav-link" data-scroll-target="#đếm-số-lần-thử"><span class="header-section-number">4.3</span> Đếm số lần thử</a>
  <ul class="collapse">
  <li><a href="#phân-phối-hình-học-geometric-distribution" id="toc-phân-phối-hình-học-geometric-distribution" class="nav-link" data-scroll-target="#phân-phối-hình-học-geometric-distribution"><span class="header-section-number">4.3.1</span> Phân phối hình học (geometric distribution)</a></li>
  <li><a href="#phân-phối-nhị-thức-âm-negative-binomial-distribution" id="toc-phân-phối-nhị-thức-âm-negative-binomial-distribution" class="nav-link" data-scroll-target="#phân-phối-nhị-thức-âm-negative-binomial-distribution"><span class="header-section-number">4.3.2</span> Phân phối nhị thức âm (negative binomial distribution)</a></li>
  </ul></li>
  <li><a href="#đếm-sự-kiện-khi-biết-tốc-độ-trung-bình" id="toc-đếm-sự-kiện-khi-biết-tốc-độ-trung-bình" class="nav-link" data-scroll-target="#đếm-sự-kiện-khi-biết-tốc-độ-trung-bình"><span class="header-section-number">4.4</span> Đếm sự kiện khi biết tốc độ trung bình</a>
  <ul class="collapse">
  <li><a href="#phân-phối-poisson" id="toc-phân-phối-poisson" class="nav-link" data-scroll-target="#phân-phối-poisson"><span class="header-section-number">4.4.1</span> Phân phối Poisson</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Phân phối rời rạc</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="phép-thử-bernoulli-bernoulli-trial-hay-binomial-trial" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="phép-thử-bernoulli-bernoulli-trial-hay-binomial-trial"><span class="header-section-number">4.1</span> Phép thử Bernoulli (Bernoulli trial, hay binomial trial)</h2>
<p>Là một lần thử nghiệm duy nhất, không gian mẫu chỉ có đúng 2 kết quả: Thành công (Success) hoặc Thất bại (Failure)</p>
<p>Ví dụ: tung đồng xu (mặt sấp, mặt ngửa), xét nghiệm một ca nghi ngờ (dương tính, âm tính)</p>
<p>Khi ta thực hiện phép thử Bernoulli nhiều lần liên tiếp (ví dụ: tung một đồng xu nhiều lần, dùng một loại xét nghiệm để test nhiều người), ta đang thực hiện 1 chuỗi Bernoulli (Bernoulli process). Chuỗi Bernoulli chuẩn cần thỏa 2 điều kiện:</p>
<ul>
<li>Độc lập (Independent): Kết quả của lần thử này không ảnh hưởng đến lần thử khác.</li>
<li>Xác suất không đổi: Xác suất thành công (<span class="math inline">\(p\)</span>) phải giống hệt nhau ở mọi lần thử.</li>
</ul>
<p>Hầu hết các phân phối rời rạc đều xuất phát từ chuỗi Bernoulli với các mục tiêu khác nhau.</p>
</section>
<section id="đếm-số-lần-thành-công" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="đếm-số-lần-thành-công"><span class="header-section-number">4.2</span> Đếm số lần thành công</h2>
<p>Chúng ta quyết định trước sẽ bỏ ra bao nhiêu công sức (<span class="math inline">\(n\)</span> lần thử), và đếm xem thu được bao nhiêu phần thưởng (<span class="math inline">\(k\)</span> thành công).</p>
<section id="phân-phối-nhị-nhức-binomial-distribution" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="phân-phối-nhị-nhức-binomial-distribution"><span class="header-section-number">4.2.1</span> Phân phối nhị nhức (binomial distribution)</h3>
<p>Đếm số lần thành công (<span class="math inline">\(k\)</span>) trong một số lượng cố định các phép thử Bernoulli độc lập (<span class="math inline">\(n\)</span>).</p>
<p>Xác suất để đạt được đúng <span class="math inline">\(k\)</span> lần thành công là:</p>
<p><span class="math display">\[P(X = k) = \binom{n}{k} p^k (1-p)^{n-k}\]</span></p>
<p>Với:</p>
<ul>
<li><span class="math inline">\(n\)</span>: Tổng số lần thực hiện phép thử</li>
<li><span class="math inline">\(p\)</span>: Xác suất thành công của mỗi lần thử (không đổi)</li>
</ul>
<section id="ví-dụ" class="level4" data-number="4.2.1.1">
<h4 data-number="4.2.1.1" class="anchored" data-anchor-id="ví-dụ"><span class="header-section-number">4.2.1.1</span> Ví dụ</h4>
<p>Tung 1 đồng xu 10 lần, sau 10 lần tung, khả năng đếm được 1, 2, 3… mặt ngửa là bao nhiêu?</p>
<ul>
<li>Tổng số lần thực hiện phép thử: <span class="math inline">\(n = 10\)</span></li>
<li>Xác suất ra mặt ngửa mỗi lần: <span class="math inline">\(p = 0.5\)</span></li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb1" data-startfrom="45" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 44;"><span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>viewof coin_sim_reset_p <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">form</span>({</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  <span class="dt">p</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="fl">0.01</span><span class="op">,</span> <span class="fl">0.99</span>]<span class="op">,</span> {<span class="dt">value</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Xác suất mặt ngửa (p)"</span>})<span class="op">,</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">flip</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">button</span>(<span class="st">"Tung 10 lần"</span>)<span class="op">,</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">auto</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">toggle</span>({<span class="dt">label</span><span class="op">:</span> <span class="st">"Tự động"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="kw">false</span>})<span class="op">,</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reset</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">button</span>(<span class="st">"Lại từ đầu"</span>)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. SETUP</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> width <span class="op">=</span> <span class="dv">450</span><span class="op">;</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> height <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> canvas <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"canvas"</span>)<span class="op">;</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> dpr <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">devicePixelRatio</span> <span class="op">||</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">width</span> <span class="op">=</span> width <span class="op">*</span> dpr<span class="op">;</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">height</span> <span class="op">=</span> height <span class="op">*</span> dpr<span class="op">;</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">width</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>width<span class="sc">}</span><span class="vs">px`</span><span class="op">;</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">height</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>height<span class="sc">}</span><span class="vs">px`</span><span class="op">;</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ctx <span class="op">=</span> canvas<span class="op">.</span><span class="fu">getContext</span>(<span class="st">"2d"</span><span class="op">,</span> { <span class="dt">alpha</span><span class="op">:</span> <span class="kw">false</span> })<span class="op">;</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  ctx<span class="op">.</span><span class="fu">scale</span>(dpr<span class="op">,</span> dpr)<span class="op">;</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  <span class="co">// CONSTANTS</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> N <span class="op">=</span> <span class="dv">10</span><span class="op">;</span> </span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  <span class="co">// COLORS</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> BG_COLOR <span class="op">=</span> <span class="st">"#f8f9fa"</span><span class="op">;</span> </span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> TEXT_COLOR <span class="op">=</span> <span class="st">"#2c3e50"</span><span class="op">;</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> HEAD_COLOR <span class="op">=</span> <span class="st">"#f1c40f"</span><span class="op">;</span> </span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> HEAD_BORDER <span class="op">=</span> <span class="st">"#d4ac0d"</span><span class="op">;</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> TAIL_COLOR <span class="op">=</span> <span class="st">"#bdc3c7"</span><span class="op">;</span> </span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> TAIL_BORDER <span class="op">=</span> <span class="st">"#95a5a6"</span><span class="op">;</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CHART_BAR <span class="op">=</span> <span class="st">"#3498db"</span><span class="op">;</span> </span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CHART_ACTIVE <span class="op">=</span> <span class="st">"#2980b9"</span><span class="op">;</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CHART_THEO <span class="op">=</span> <span class="st">"rgba(44, 62, 80, 0.1)"</span><span class="op">;</span> </span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  <span class="co">// MATH HELPER</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">binomial</span>(k<span class="op">,</span> n<span class="op">,</span> p) {</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">nCr</span>(n<span class="op">,</span> r) {</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (r <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> r <span class="op">&gt;</span> n) <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> res <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(<span class="kw">let</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>r<span class="op">;</span> i<span class="op">++</span>) res <span class="op">=</span> res <span class="op">*</span> (n <span class="op">-</span> i) <span class="op">/</span> (i <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">nCr</span>(n<span class="op">,</span> k) <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(p<span class="op">,</span> k) <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">1</span> <span class="op">-</span> p<span class="op">,</span> n <span class="op">-</span> k)<span class="op">;</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. STATE</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">stateCoinReset</span>) {</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">stateCoinReset</span> <span class="op">=</span> {</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>       <span class="dt">history</span><span class="op">:</span> []<span class="op">,</span> </span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>       <span class="dt">counts</span><span class="op">:</span> {}<span class="op">,</span>  </span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>       <span class="dt">totalFlips</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>       <span class="dt">currentResult</span><span class="op">:</span> []<span class="op">,</span> </span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>       <span class="dt">animation</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> </span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>       <span class="dt">cooldown</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>       <span class="dt">lastFlipVal</span><span class="op">:</span> coin_sim_reset_p<span class="op">.</span><span class="at">flip</span><span class="op">,</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>       <span class="dt">lastResetVal</span><span class="op">:</span> coin_sim_reset_p<span class="op">.</span><span class="at">reset</span><span class="op">,</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>       <span class="dt">lastP</span><span class="op">:</span> coin_sim_reset_p<span class="op">.</span><span class="at">p</span> <span class="co">// Track P to detect changes</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(<span class="kw">let</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;=</span>N<span class="op">;</span> i<span class="op">++</span>) <span class="kw">this</span><span class="op">.</span><span class="at">stateCoinReset</span><span class="op">.</span><span class="at">counts</span>[i] <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> S <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">stateCoinReset</span><span class="op">;</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Current P</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> P <span class="op">=</span> coin_sim_reset_p<span class="op">.</span><span class="at">p</span><span class="op">;</span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. LOGIC</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Helper to clear data</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">doReset</span>() {</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">history</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>     <span class="cf">for</span>(<span class="kw">let</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;=</span>N<span class="op">;</span> i<span class="op">++</span>) S<span class="op">.</span><span class="at">counts</span>[i] <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">totalFlips</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">currentResult</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">animation</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>  <span class="co">// A. Explicit Reset Button</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (coin_sim_reset_p<span class="op">.</span><span class="at">reset</span> <span class="op">&gt;</span> S<span class="op">.</span><span class="at">lastResetVal</span>) {</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>     <span class="fu">doReset</span>()<span class="op">;</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">lastResetVal</span> <span class="op">=</span> coin_sim_reset_p<span class="op">.</span><span class="at">reset</span><span class="op">;</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>  <span class="co">// B. Auto-Reset on Probability Change</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If the user moved the slider, we wipe the data immediately.</span></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (P <span class="op">!==</span> S<span class="op">.</span><span class="at">lastP</span>) {</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>     <span class="fu">doReset</span>()<span class="op">;</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">lastP</span> <span class="op">=</span> P<span class="op">;</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Flip Function</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">runFlip</span>() {</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>     <span class="kw">let</span> heads <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>     <span class="kw">const</span> res <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>     <span class="cf">for</span>(<span class="kw">let</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>N<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> isHead <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">&lt;</span> P<span class="op">;</span></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>        res<span class="op">.</span><span class="fu">push</span>(isHead <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (isHead) heads<span class="op">++;</span></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>     <span class="kw">const</span> coinSize <span class="op">=</span> <span class="dv">28</span><span class="op">;</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>     <span class="kw">const</span> gap <span class="op">=</span> <span class="dv">6</span><span class="op">;</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>     <span class="kw">const</span> totalW <span class="op">=</span> N <span class="op">*</span> coinSize <span class="op">+</span> (N<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span>gap<span class="op">;</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>     <span class="kw">const</span> startX <span class="op">=</span> (width <span class="op">-</span> totalW) <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> coinSize<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">currentResult</span> <span class="op">=</span> res<span class="op">.</span><span class="fu">map</span>((val<span class="op">,</span> i) <span class="kw">=&gt;</span> ({</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>        <span class="dt">val</span><span class="op">:</span> val<span class="op">,</span></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> width<span class="op">/</span><span class="dv">2</span><span class="op">,</span> </span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>        <span class="dt">targetX</span><span class="op">:</span> startX <span class="op">+</span> i <span class="op">*</span> (coinSize <span class="op">+</span> gap)<span class="op">,</span> </span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>        <span class="dt">targetY</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> coinSize <span class="op">/</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>        <span class="dt">t</span><span class="op">:</span> <span class="dv">0</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>     }))<span class="op">;</span></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">history</span><span class="op">.</span><span class="fu">push</span>(heads)<span class="op">;</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">counts</span>[heads] <span class="op">=</span> (S<span class="op">.</span><span class="at">counts</span>[heads] <span class="op">||</span> <span class="dv">0</span>) <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">totalFlips</span><span class="op">++;</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">animation</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">cooldown</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Manual Flip Check</span></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (coin_sim_reset_p<span class="op">.</span><span class="at">flip</span> <span class="op">&gt;</span> S<span class="op">.</span><span class="at">lastFlipVal</span>) {</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>     <span class="fu">runFlip</span>()<span class="op">;</span></span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">lastFlipVal</span> <span class="op">=</span> coin_sim_reset_p<span class="op">.</span><span class="at">flip</span><span class="op">;</span></span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. RENDER LOOP</span></span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">update</span>() {</span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> viewof coin_sim_reset_p<span class="op">;</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> checkbox <span class="op">=</span> form<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"input[type=checkbox]"</span>)<span class="op">;</span></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> isAuto <span class="op">=</span> checkbox <span class="op">?</span> checkbox<span class="op">.</span><span class="at">checked</span> <span class="op">:</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (S<span class="op">.</span><span class="at">animation</span> <span class="op">===</span> <span class="dv">1</span>) {</span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>       <span class="kw">let</span> done <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> (<span class="kw">let</span> c <span class="kw">of</span> S<span class="op">.</span><span class="at">currentResult</span>) {</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (c<span class="op">.</span><span class="at">t</span> <span class="op">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>             c<span class="op">.</span><span class="at">t</span> <span class="op">+=</span> <span class="fl">0.15</span><span class="op">;</span> </span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>             <span class="cf">if</span> (c<span class="op">.</span><span class="at">t</span> <span class="op">&gt;</span> <span class="dv">1</span>) c<span class="op">.</span><span class="at">t</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>             <span class="kw">const</span> ease <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">1</span> <span class="op">-</span> c<span class="op">.</span><span class="at">t</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span> </span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>             c<span class="op">.</span><span class="at">x</span> <span class="op">=</span> width<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> (c<span class="op">.</span><span class="at">targetX</span> <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> ease<span class="op">;</span></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>             c<span class="op">.</span><span class="at">y</span> <span class="op">=</span> c<span class="op">.</span><span class="at">targetY</span> <span class="op">-</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(c<span class="op">.</span><span class="at">t</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span>) <span class="op">*</span> <span class="dv">20</span><span class="op">;</span> </span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>             done <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>       }</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span> (done) S<span class="op">.</span><span class="at">animation</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (isAuto) {</span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>       S<span class="op">.</span><span class="at">cooldown</span><span class="op">++;</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span> (S<span class="op">.</span><span class="at">cooldown</span> <span class="op">&gt;</span> <span class="dv">90</span>) <span class="fu">runFlip</span>()<span class="op">;</span></span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">draw</span>() {</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> viewof coin_sim_reset_p<span class="op">;</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> checkbox <span class="op">=</span> form<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"input[type=checkbox]"</span>)<span class="op">;</span></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> isAuto <span class="op">=</span> checkbox <span class="op">?</span> checkbox<span class="op">.</span><span class="at">checked</span> <span class="op">:</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> BG_COLOR<span class="op">;</span></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">fillRect</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> width<span class="op">,</span> height)<span class="op">;</span></span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">textAlign</span> <span class="op">=</span> <span class="st">"left"</span><span class="op">;</span></span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> TEXT_COLOR<span class="op">;</span></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">font</span> <span class="op">=</span> <span class="st">"bold 14px sans-serif"</span><span class="op">;</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">fillText</span>(<span class="vs">`Lần thứ </span><span class="sc">${</span>S<span class="op">.</span><span class="at">totalFlips</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">30</span>)<span class="op">;</span></span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (isAuto) {</span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> <span class="st">"#27ae60"</span><span class="op">;</span></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">fillText</span>(<span class="st">"● Tự động"</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">30</span>)<span class="op">;</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (S<span class="op">.</span><span class="at">currentResult</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> hCount <span class="op">=</span> S<span class="op">.</span><span class="at">currentResult</span><span class="op">.</span><span class="fu">filter</span>(c <span class="kw">=&gt;</span> c<span class="op">.</span><span class="at">val</span><span class="op">===</span><span class="dv">1</span>)<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">textAlign</span> <span class="op">=</span> <span class="st">"right"</span><span class="op">;</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> TEXT_COLOR<span class="op">;</span></span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">fillText</span>(<span class="vs">`Mặt ngửa: </span><span class="sc">${</span>hCount<span class="sc">}</span><span class="vs"> / </span><span class="sc">${</span>N<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> width <span class="op">-</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">30</span>)<span class="op">;</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> c <span class="kw">of</span> S<span class="op">.</span><span class="at">currentResult</span>) {</span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">beginPath</span>()<span class="op">;</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">arc</span>(c<span class="op">.</span><span class="at">x</span><span class="op">,</span> c<span class="op">.</span><span class="at">y</span><span class="op">,</span> c<span class="op">.</span><span class="at">r</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span><span class="op">*</span><span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> c<span class="op">.</span><span class="at">val</span> <span class="op">===</span> <span class="dv">1</span> <span class="op">?</span> HEAD_COLOR <span class="op">:</span> TAIL_COLOR<span class="op">;</span></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">fill</span>()<span class="op">;</span></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">strokeStyle</span> <span class="op">=</span> c<span class="op">.</span><span class="at">val</span> <span class="op">===</span> <span class="dv">1</span> <span class="op">?</span> HEAD_BORDER <span class="op">:</span> TAIL_BORDER<span class="op">;</span></span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">stroke</span>()<span class="op">;</span></span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> <span class="st">"white"</span><span class="op">;</span></span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">textAlign</span> <span class="op">=</span> <span class="st">"center"</span><span class="op">;</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">textBaseline</span> <span class="op">=</span> <span class="st">"middle"</span><span class="op">;</span></span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">font</span> <span class="op">=</span> <span class="vs">`bold </span><span class="sc">${</span>c<span class="op">.</span><span class="at">r</span><span class="sc">}</span><span class="vs">px sans-serif`</span><span class="op">;</span></span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">fillText</span>(c<span class="op">.</span><span class="at">val</span> <span class="op">===</span> <span class="dv">1</span> <span class="op">?</span> <span class="st">"N"</span> <span class="op">:</span> <span class="st">"S"</span><span class="op">,</span> c<span class="op">.</span><span class="at">x</span><span class="op">,</span> c<span class="op">.</span><span class="at">y</span> <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> chartY <span class="op">=</span> <span class="dv">360</span><span class="op">;</span></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> chartH <span class="op">=</span> <span class="dv">200</span><span class="op">;</span></span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> chartX <span class="op">=</span> <span class="dv">40</span><span class="op">;</span></span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> chartW <span class="op">=</span> width <span class="op">-</span> <span class="dv">60</span><span class="op">;</span></span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">beginPath</span>()<span class="op">;</span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">strokeStyle</span> <span class="op">=</span> <span class="st">"#bdc3c7"</span><span class="op">;</span></span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">moveTo</span>(chartX<span class="op">,</span> chartY)<span class="op">;</span></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">lineTo</span>(chartX <span class="op">+</span> chartW<span class="op">,</span> chartY)<span class="op">;</span></span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">stroke</span>()<span class="op">;</span></span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> barW <span class="op">=</span> chartW <span class="op">/</span> (N <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Scale Y-axis based on CURRENT P</span></span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> maxTheoreticalProb <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(<span class="kw">let</span> k<span class="op">=</span><span class="dv">0</span><span class="op">;</span> k<span class="op">&lt;=</span>N<span class="op">;</span> k<span class="op">++</span>) {</span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> prob <span class="op">=</span> <span class="fu">binomial</span>(k<span class="op">,</span> N<span class="op">,</span> P)<span class="op">;</span></span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(prob <span class="op">&gt;</span> maxTheoreticalProb) maxTheoreticalProb <span class="op">=</span> prob<span class="op">;</span></span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Y_SCALE_MAX <span class="op">=</span> maxTheoreticalProb <span class="op">*</span> <span class="fl">1.2</span><span class="op">;</span> </span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> activeHeads <span class="op">=</span> S<span class="op">.</span><span class="at">currentResult</span><span class="op">.</span><span class="fu">filter</span>(c <span class="kw">=&gt;</span> c<span class="op">.</span><span class="at">val</span><span class="op">===</span><span class="dv">1</span>)<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> k <span class="op">&lt;=</span> N<span class="op">;</span> k<span class="op">++</span>) {</span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> cx <span class="op">=</span> chartX <span class="op">+</span> k <span class="op">*</span> barW <span class="op">+</span> barW<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>       <span class="co">// Theoretical Bar</span></span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> prob <span class="op">=</span> <span class="fu">binomial</span>(k<span class="op">,</span> N<span class="op">,</span> P)<span class="op">;</span></span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> theoH <span class="op">=</span> (prob <span class="op">/</span> Y_SCALE_MAX) <span class="op">*</span> chartH<span class="op">;</span></span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> CHART_THEO<span class="op">;</span></span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">fillRect</span>(cx <span class="op">-</span> barW<span class="op">*</span><span class="fl">0.3</span><span class="op">,</span> chartY <span class="op">-</span> theoH<span class="op">,</span> barW<span class="op">*</span><span class="fl">0.6</span><span class="op">,</span> theoH)<span class="op">;</span></span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>       <span class="co">// Actual Bar</span></span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>       <span class="kw">let</span> observedProb <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span> (S<span class="op">.</span><span class="at">totalFlips</span> <span class="op">&gt;</span> <span class="dv">0</span>) observedProb <span class="op">=</span> S<span class="op">.</span><span class="at">counts</span>[k] <span class="op">/</span> S<span class="op">.</span><span class="at">totalFlips</span><span class="op">;</span></span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a>       <span class="kw">let</span> barH <span class="op">=</span> (observedProb <span class="op">/</span> Y_SCALE_MAX) <span class="op">*</span> chartH<span class="op">;</span></span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span> (barH <span class="op">&gt;</span> chartH <span class="op">+</span> <span class="dv">20</span>) barH <span class="op">=</span> chartH <span class="op">+</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> isActive <span class="op">=</span> (S<span class="op">.</span><span class="at">animation</span> <span class="op">===</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> k <span class="op">===</span> activeHeads <span class="op">&amp;&amp;</span> S<span class="op">.</span><span class="at">totalFlips</span> <span class="op">&gt;</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> isActive <span class="op">?</span> CHART_ACTIVE <span class="op">:</span> CHART_BAR<span class="op">;</span></span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">fillRect</span>(cx <span class="op">-</span> barW<span class="op">*</span><span class="fl">0.3</span><span class="op">,</span> chartY <span class="op">-</span> barH<span class="op">,</span> barW<span class="op">*</span><span class="fl">0.6</span><span class="op">,</span> barH)<span class="op">;</span></span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> TEXT_COLOR<span class="op">;</span></span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">font</span> <span class="op">=</span> <span class="st">"10px sans-serif"</span><span class="op">;</span></span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">textAlign</span> <span class="op">=</span> <span class="st">"center"</span><span class="op">;</span></span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">fillText</span>(k<span class="op">,</span> cx<span class="op">,</span> chartY <span class="op">+</span> <span class="dv">15</span>)<span class="op">;</span></span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">save</span>()<span class="op">;</span></span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">translate</span>(<span class="dv">12</span><span class="op">,</span> chartY <span class="op">-</span> chartH<span class="op">/</span><span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">rotate</span>(<span class="op">-</span><span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span><span class="op">/</span><span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">textAlign</span> <span class="op">=</span> <span class="st">"center"</span><span class="op">;</span></span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> <span class="st">"#7f8c8d"</span><span class="op">;</span></span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">fillText</span>(<span class="st">"Xác suất"</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">restore</span>()<span class="op">;</span></span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> frameId<span class="op">;</span></span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">tick</span>() {</span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update</span>()<span class="op">;</span></span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a>    <span class="fu">draw</span>()<span class="op">;</span></span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a>    frameId <span class="op">=</span> <span class="fu">requestAnimationFrame</span>(tick)<span class="op">;</span></span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tick</span>()<span class="op">;</span></span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">assign</span>(canvas<span class="op">,</span> {</span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a>    <span class="dt">remove</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="fu">cancelAnimationFrame</span>(frameId)</span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-2" data-nodetype="expression">

</div>
</div>
</div>
</div>
</section>
<section id="bảng-galton" class="level4" data-number="4.2.1.2">
<h4 data-number="4.2.1.2" class="anchored" data-anchor-id="bảng-galton"><span class="header-section-number">4.2.1.2</span> Bảng Galton</h4>
<p>Bảng Galton (Galton board) là một tấm bảng dựng đứng, được đóng các hàng đinh so le nhau theo hình tam giác. Ta thả những viên bi nhỏ từ đỉnh tháp. Khi một viên bi chạm vào một chiếc đinh, nó sẽ nảy sang trái hoặc sang phải. Sau khi đi hết các hàng đinh, viên bi sẽ rơi vào các ô chứa để hứng bi. Số lượng bi trong các ô chứa này tuân theo phân phối nhị thức.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb2" data-startfrom="319" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 318;"><span id="cb2-319"><a href="#cb2-319" aria-hidden="true" tabindex="-1"></a>viewof galton_sharp <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">form</span>({</span>
<span id="cb2-320"><a href="#cb2-320" aria-hidden="true" tabindex="-1"></a>  <span class="dt">rows</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="dv">8</span><span class="op">,</span> <span class="dv">20</span>]<span class="op">,</span> {<span class="dt">value</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Số hàng đinh"</span>})<span class="op">,</span></span>
<span id="cb2-321"><a href="#cb2-321" aria-hidden="true" tabindex="-1"></a>  <span class="dt">speed</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="fl">0.5</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span> {<span class="dt">value</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Tốc độ"</span>})<span class="op">,</span></span>
<span id="cb2-322"><a href="#cb2-322" aria-hidden="true" tabindex="-1"></a>  <span class="dt">total</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="dv">50</span><span class="op">,</span> <span class="dv">800</span>]<span class="op">,</span> {<span class="dt">value</span><span class="op">:</span> <span class="dv">200</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Số viên bi"</span>})</span>
<span id="cb2-323"><a href="#cb2-323" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-324"><a href="#cb2-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-325"><a href="#cb2-325" aria-hidden="true" tabindex="-1"></a>viewof control_sharp <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">form</span>({</span>
<span id="cb2-326"><a href="#cb2-326" aria-hidden="true" tabindex="-1"></a>  <span class="dt">start</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">button</span>(<span class="st">"Bắt đầu"</span><span class="op">,</span> {<span class="dt">value</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span> <span class="dt">reduce</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"START"</span>})<span class="op">,</span></span>
<span id="cb2-327"><a href="#cb2-327" aria-hidden="true" tabindex="-1"></a>  <span class="dt">stop</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">button</span>(<span class="st">"Dừng"</span><span class="op">,</span> {<span class="dt">value</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span> <span class="dt">reduce</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"STOP"</span>})</span>
<span id="cb2-328"><a href="#cb2-328" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-329"><a href="#cb2-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-330"><a href="#cb2-330" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-331"><a href="#cb2-331" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> rows <span class="op">=</span> galton_sharp<span class="op">.</span><span class="at">rows</span><span class="op">;</span></span>
<span id="cb2-332"><a href="#cb2-332" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> speed <span class="op">=</span> galton_sharp<span class="op">.</span><span class="at">speed</span><span class="op">;</span></span>
<span id="cb2-333"><a href="#cb2-333" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> maxBalls <span class="op">=</span> galton_sharp<span class="op">.</span><span class="at">total</span><span class="op">;</span></span>
<span id="cb2-334"><a href="#cb2-334" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-335"><a href="#cb2-335" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. DIMENSIONS</span></span>
<span id="cb2-336"><a href="#cb2-336" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The "Logical" size (how big it looks on screen)</span></span>
<span id="cb2-337"><a href="#cb2-337" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> logicalWidth <span class="op">=</span> <span class="dv">360</span><span class="op">;</span></span>
<span id="cb2-338"><a href="#cb2-338" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> logicalHeight <span class="op">=</span> <span class="dv">600</span><span class="op">;</span></span>
<span id="cb2-339"><a href="#cb2-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-340"><a href="#cb2-340" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. HIGH-DPI SCALING</span></span>
<span id="cb2-341"><a href="#cb2-341" aria-hidden="true" tabindex="-1"></a>  <span class="co">// We detect the user's screen density (e.g., 2.0 for Retina)</span></span>
<span id="cb2-342"><a href="#cb2-342" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> dpr <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">devicePixelRatio</span> <span class="op">||</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-343"><a href="#cb2-343" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-344"><a href="#cb2-344" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> canvas <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"canvas"</span>)<span class="op">;</span></span>
<span id="cb2-345"><a href="#cb2-345" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set the "Real" size (pixels in memory) higher</span></span>
<span id="cb2-346"><a href="#cb2-346" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">width</span> <span class="op">=</span> logicalWidth <span class="op">*</span> dpr<span class="op">;</span></span>
<span id="cb2-347"><a href="#cb2-347" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">height</span> <span class="op">=</span> logicalHeight <span class="op">*</span> dpr<span class="op">;</span></span>
<span id="cb2-348"><a href="#cb2-348" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set the "CSS" size (pixels on screen) standard</span></span>
<span id="cb2-349"><a href="#cb2-349" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">width</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>logicalWidth<span class="sc">}</span><span class="vs">px`</span><span class="op">;</span></span>
<span id="cb2-350"><a href="#cb2-350" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">height</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>logicalHeight<span class="sc">}</span><span class="vs">px`</span><span class="op">;</span></span>
<span id="cb2-351"><a href="#cb2-351" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-352"><a href="#cb2-352" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ctx <span class="op">=</span> canvas<span class="op">.</span><span class="fu">getContext</span>(<span class="st">"2d"</span>)<span class="op">;</span></span>
<span id="cb2-353"><a href="#cb2-353" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale all drawing operations automatically</span></span>
<span id="cb2-354"><a href="#cb2-354" aria-hidden="true" tabindex="-1"></a>  ctx<span class="op">.</span><span class="fu">scale</span>(dpr<span class="op">,</span> dpr)<span class="op">;</span></span>
<span id="cb2-355"><a href="#cb2-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-356"><a href="#cb2-356" aria-hidden="true" tabindex="-1"></a>  <span class="co">// --- GEOMETRY (Uses logical units) ---</span></span>
<span id="cb2-357"><a href="#cb2-357" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> pegSpacing <span class="op">=</span> logicalWidth <span class="op">/</span> (rows <span class="op">+</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb2-358"><a href="#cb2-358" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> rowHeight <span class="op">=</span> pegSpacing <span class="op">*</span> <span class="fl">0.85</span><span class="op">;</span> </span>
<span id="cb2-359"><a href="#cb2-359" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> startY <span class="op">=</span> <span class="dv">60</span><span class="op">;</span></span>
<span id="cb2-360"><a href="#cb2-360" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> pegRadius <span class="op">=</span> pegSpacing <span class="op">*</span> <span class="fl">0.12</span><span class="op">;</span> </span>
<span id="cb2-361"><a href="#cb2-361" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ballRadius <span class="op">=</span> pegSpacing <span class="op">*</span> <span class="fl">0.23</span><span class="op">;</span> </span>
<span id="cb2-362"><a href="#cb2-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-363"><a href="#cb2-363" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> floorY <span class="op">=</span> logicalHeight <span class="op">-</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb2-364"><a href="#cb2-364" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> binWidth <span class="op">=</span> pegSpacing<span class="op">;</span></span>
<span id="cb2-365"><a href="#cb2-365" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> totalBinWidth <span class="op">=</span> (rows <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> binWidth<span class="op">;</span></span>
<span id="cb2-366"><a href="#cb2-366" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> binsStartX <span class="op">=</span> (logicalWidth <span class="op">-</span> totalBinWidth) <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-367"><a href="#cb2-367" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> wallsTopY <span class="op">=</span> startY <span class="op">+</span> (rows) <span class="op">*</span> rowHeight <span class="op">+</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb2-368"><a href="#cb2-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-369"><a href="#cb2-369" aria-hidden="true" tabindex="-1"></a>  <span class="co">// PRE-COMPUTE BOARD</span></span>
<span id="cb2-370"><a href="#cb2-370" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> pegGrid <span class="op">=</span> []<span class="op">;</span> </span>
<span id="cb2-371"><a href="#cb2-371" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> r <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> r <span class="op">&lt;</span> rows<span class="op">;</span> r<span class="op">++</span>) {</span>
<span id="cb2-372"><a href="#cb2-372" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> rowPegs <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb2-373"><a href="#cb2-373" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> pegsInThisRow <span class="op">=</span> r <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-374"><a href="#cb2-374" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> rowWidth <span class="op">=</span> (pegsInThisRow <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> pegSpacing<span class="op">;</span></span>
<span id="cb2-375"><a href="#cb2-375" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> rowStartX <span class="op">=</span> (logicalWidth <span class="op">-</span> rowWidth) <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-376"><a href="#cb2-376" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> p <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> p <span class="op">&lt;</span> pegsInThisRow<span class="op">;</span> p<span class="op">++</span>) {</span>
<span id="cb2-377"><a href="#cb2-377" aria-hidden="true" tabindex="-1"></a>      rowPegs<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb2-378"><a href="#cb2-378" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> rowStartX <span class="op">+</span> p <span class="op">*</span> pegSpacing<span class="op">,</span></span>
<span id="cb2-379"><a href="#cb2-379" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> startY <span class="op">+</span> r <span class="op">*</span> rowHeight</span>
<span id="cb2-380"><a href="#cb2-380" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-381"><a href="#cb2-381" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-382"><a href="#cb2-382" aria-hidden="true" tabindex="-1"></a>    pegGrid<span class="op">.</span><span class="fu">push</span>(rowPegs)<span class="op">;</span></span>
<span id="cb2-383"><a href="#cb2-383" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-384"><a href="#cb2-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-385"><a href="#cb2-385" aria-hidden="true" tabindex="-1"></a>  <span class="co">// STATE</span></span>
<span id="cb2-386"><a href="#cb2-386" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> balls <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb2-387"><a href="#cb2-387" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> bins <span class="op">=</span> <span class="kw">new</span> <span class="bu">Array</span>(rows <span class="op">+</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">fill</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb2-388"><a href="#cb2-388" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> spawnedCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-389"><a href="#cb2-389" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> isRunning <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb2-390"><a href="#cb2-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-391"><a href="#cb2-391" aria-hidden="true" tabindex="-1"></a>  <span class="co">// CONTROLS</span></span>
<span id="cb2-392"><a href="#cb2-392" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> startBtn <span class="op">=</span> viewof control_sharp<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"button"</span>)<span class="op">;</span> </span>
<span id="cb2-393"><a href="#cb2-393" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stopBtn <span class="op">=</span> viewof control_sharp<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">"button"</span>)[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb2-394"><a href="#cb2-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-395"><a href="#cb2-395" aria-hidden="true" tabindex="-1"></a>  startBtn<span class="op">.</span><span class="at">onclick</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb2-396"><a href="#cb2-396" aria-hidden="true" tabindex="-1"></a>    balls <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb2-397"><a href="#cb2-397" aria-hidden="true" tabindex="-1"></a>    bins <span class="op">=</span> <span class="kw">new</span> <span class="bu">Array</span>(rows <span class="op">+</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">fill</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb2-398"><a href="#cb2-398" aria-hidden="true" tabindex="-1"></a>    spawnedCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-399"><a href="#cb2-399" aria-hidden="true" tabindex="-1"></a>    isRunning <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb2-400"><a href="#cb2-400" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb2-401"><a href="#cb2-401" aria-hidden="true" tabindex="-1"></a>  stopBtn<span class="op">.</span><span class="at">onclick</span> <span class="op">=</span> () <span class="kw">=&gt;</span> { isRunning <span class="op">=</span> <span class="kw">false</span><span class="op">;</span> }<span class="op">;</span></span>
<span id="cb2-402"><a href="#cb2-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-403"><a href="#cb2-403" aria-hidden="true" tabindex="-1"></a>  <span class="co">// PATH LOGIC</span></span>
<span id="cb2-404"><a href="#cb2-404" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">createBall</span>() {</span>
<span id="cb2-405"><a href="#cb2-405" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> currentInd <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> </span>
<span id="cb2-406"><a href="#cb2-406" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> path <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb2-407"><a href="#cb2-407" aria-hidden="true" tabindex="-1"></a>    path<span class="op">.</span><span class="fu">push</span>({ <span class="dt">x</span><span class="op">:</span> logicalWidth <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> startY <span class="op">-</span> <span class="dv">20</span> })<span class="op">;</span></span>
<span id="cb2-408"><a href="#cb2-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-409"><a href="#cb2-409" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> r <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> r <span class="op">&lt;</span> rows<span class="op">;</span> r<span class="op">++</span>) {</span>
<span id="cb2-410"><a href="#cb2-410" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> peg <span class="op">=</span> pegGrid[r][currentInd]<span class="op">;</span></span>
<span id="cb2-411"><a href="#cb2-411" aria-hidden="true" tabindex="-1"></a>       path<span class="op">.</span><span class="fu">push</span>({ <span class="dt">x</span><span class="op">:</span> peg<span class="op">.</span><span class="at">x</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> peg<span class="op">.</span><span class="at">y</span> <span class="op">-</span> pegRadius <span class="op">-</span> ballRadius })<span class="op">;</span></span>
<span id="cb2-412"><a href="#cb2-412" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span> (<span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">&gt;</span> <span class="fl">0.5</span>) currentInd<span class="op">++;</span> </span>
<span id="cb2-413"><a href="#cb2-413" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-414"><a href="#cb2-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-415"><a href="#cb2-415" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> binX <span class="op">=</span> binsStartX <span class="op">+</span> currentInd <span class="op">*</span> binWidth <span class="op">+</span> binWidth<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-416"><a href="#cb2-416" aria-hidden="true" tabindex="-1"></a>    path<span class="op">.</span><span class="fu">push</span>({ <span class="dt">x</span><span class="op">:</span> binX<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> wallsTopY })<span class="op">;</span></span>
<span id="cb2-417"><a href="#cb2-417" aria-hidden="true" tabindex="-1"></a>    path<span class="op">.</span><span class="fu">push</span>({ <span class="dt">x</span><span class="op">:</span> binX<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> floorY <span class="op">-</span> ballRadius<span class="op">,</span> <span class="dt">isFloor</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">binIndex</span><span class="op">:</span> currentInd })<span class="op">;</span></span>
<span id="cb2-418"><a href="#cb2-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-419"><a href="#cb2-419" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb2-420"><a href="#cb2-420" aria-hidden="true" tabindex="-1"></a>      <span class="dt">path</span><span class="op">:</span> path<span class="op">,</span></span>
<span id="cb2-421"><a href="#cb2-421" aria-hidden="true" tabindex="-1"></a>      <span class="dt">segment</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">t</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">active</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb2-422"><a href="#cb2-422" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> path[<span class="dv">0</span>]<span class="op">.</span><span class="at">x</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> path[<span class="dv">0</span>]<span class="op">.</span><span class="at">y</span></span>
<span id="cb2-423"><a href="#cb2-423" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb2-424"><a href="#cb2-424" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-425"><a href="#cb2-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-426"><a href="#cb2-426" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">spawnBall</span>() {</span>
<span id="cb2-427"><a href="#cb2-427" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>isRunning) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb2-428"><a href="#cb2-428" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (spawnedCount <span class="op">&gt;=</span> maxBalls) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb2-429"><a href="#cb2-429" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-430"><a href="#cb2-430" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> centerBinIdx <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(rows <span class="op">/</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb2-431"><a href="#cb2-431" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> maxCapacity <span class="op">=</span> (floorY <span class="op">-</span> wallsTopY) <span class="op">/</span> (ballRadius <span class="op">*</span> <span class="fl">0.6</span>)<span class="op">;</span> </span>
<span id="cb2-432"><a href="#cb2-432" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (bins[centerBinIdx] <span class="op">&gt;=</span> maxCapacity) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb2-433"><a href="#cb2-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-434"><a href="#cb2-434" aria-hidden="true" tabindex="-1"></a>    balls<span class="op">.</span><span class="fu">push</span>(<span class="fu">createBall</span>())<span class="op">;</span></span>
<span id="cb2-435"><a href="#cb2-435" aria-hidden="true" tabindex="-1"></a>    spawnedCount<span class="op">++;</span></span>
<span id="cb2-436"><a href="#cb2-436" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-437"><a href="#cb2-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-438"><a href="#cb2-438" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">update</span>(dt) {</span>
<span id="cb2-439"><a href="#cb2-439" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> spawnRate <span class="op">=</span> <span class="fl">0.15</span> <span class="op">/</span> speed<span class="op">;</span> </span>
<span id="cb2-440"><a href="#cb2-440" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (isRunning <span class="op">&amp;&amp;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">&lt;</span> dt <span class="op">/</span> spawnRate) <span class="fu">spawnBall</span>()<span class="op">;</span></span>
<span id="cb2-441"><a href="#cb2-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-442"><a href="#cb2-442" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> b <span class="kw">of</span> balls) {</span>
<span id="cb2-443"><a href="#cb2-443" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>b<span class="op">.</span><span class="at">active</span>) <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb2-444"><a href="#cb2-444" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>isRunning) <span class="cf">continue</span><span class="op">;</span> </span>
<span id="cb2-445"><a href="#cb2-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-446"><a href="#cb2-446" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> moveSpeed <span class="op">=</span> <span class="fl">3.5</span> <span class="op">*</span> speed <span class="op">*</span> dt<span class="op">;</span> </span>
<span id="cb2-447"><a href="#cb2-447" aria-hidden="true" tabindex="-1"></a>      b<span class="op">.</span><span class="at">t</span> <span class="op">+=</span> moveSpeed<span class="op">;</span></span>
<span id="cb2-448"><a href="#cb2-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-449"><a href="#cb2-449" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (b<span class="op">.</span><span class="at">t</span> <span class="op">&gt;=</span> <span class="dv">1</span>) {</span>
<span id="cb2-450"><a href="#cb2-450" aria-hidden="true" tabindex="-1"></a>        b<span class="op">.</span><span class="at">t</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-451"><a href="#cb2-451" aria-hidden="true" tabindex="-1"></a>        b<span class="op">.</span><span class="at">segment</span><span class="op">++;</span></span>
<span id="cb2-452"><a href="#cb2-452" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (b<span class="op">.</span><span class="at">segment</span> <span class="op">&gt;=</span> b<span class="op">.</span><span class="at">path</span><span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>) {</span>
<span id="cb2-453"><a href="#cb2-453" aria-hidden="true" tabindex="-1"></a>           b<span class="op">.</span><span class="at">active</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb2-454"><a href="#cb2-454" aria-hidden="true" tabindex="-1"></a>           <span class="kw">const</span> finalPt <span class="op">=</span> b<span class="op">.</span><span class="at">path</span>[b<span class="op">.</span><span class="at">path</span><span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb2-455"><a href="#cb2-455" aria-hidden="true" tabindex="-1"></a>           bins[finalPt<span class="op">.</span><span class="at">binIndex</span>]<span class="op">++;</span></span>
<span id="cb2-456"><a href="#cb2-456" aria-hidden="true" tabindex="-1"></a>           <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb2-457"><a href="#cb2-457" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-458"><a href="#cb2-458" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-459"><a href="#cb2-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-460"><a href="#cb2-460" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> p0 <span class="op">=</span> b<span class="op">.</span><span class="at">path</span>[b<span class="op">.</span><span class="at">segment</span>]<span class="op">;</span></span>
<span id="cb2-461"><a href="#cb2-461" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> p1 <span class="op">=</span> b<span class="op">.</span><span class="at">path</span>[b<span class="op">.</span><span class="at">segment</span> <span class="op">+</span> <span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb2-462"><a href="#cb2-462" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-463"><a href="#cb2-463" aria-hidden="true" tabindex="-1"></a>      b<span class="op">.</span><span class="at">x</span> <span class="op">=</span> p0<span class="op">.</span><span class="at">x</span> <span class="op">+</span> (p1<span class="op">.</span><span class="at">x</span> <span class="op">-</span> p0<span class="op">.</span><span class="at">x</span>) <span class="op">*</span> b<span class="op">.</span><span class="at">t</span><span class="op">;</span></span>
<span id="cb2-464"><a href="#cb2-464" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (p1<span class="op">.</span><span class="at">isFloor</span>) {</span>
<span id="cb2-465"><a href="#cb2-465" aria-hidden="true" tabindex="-1"></a>         b<span class="op">.</span><span class="at">y</span> <span class="op">=</span> p0<span class="op">.</span><span class="at">y</span> <span class="op">+</span> (p1<span class="op">.</span><span class="at">y</span> <span class="op">-</span> p0<span class="op">.</span><span class="at">y</span>) <span class="op">*</span> (b<span class="op">.</span><span class="at">t</span> <span class="op">*</span> b<span class="op">.</span><span class="at">t</span>)<span class="op">;</span> </span>
<span id="cb2-466"><a href="#cb2-466" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb2-467"><a href="#cb2-467" aria-hidden="true" tabindex="-1"></a>         b<span class="op">.</span><span class="at">y</span> <span class="op">=</span> p0<span class="op">.</span><span class="at">y</span> <span class="op">+</span> (p1<span class="op">.</span><span class="at">y</span> <span class="op">-</span> p0<span class="op">.</span><span class="at">y</span>) <span class="op">*</span> (b<span class="op">.</span><span class="at">t</span> <span class="op">*</span> b<span class="op">.</span><span class="at">t</span>)<span class="op">;</span> </span>
<span id="cb2-468"><a href="#cb2-468" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-469"><a href="#cb2-469" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-470"><a href="#cb2-470" aria-hidden="true" tabindex="-1"></a>    balls <span class="op">=</span> balls<span class="op">.</span><span class="fu">filter</span>(b <span class="kw">=&gt;</span> b<span class="op">.</span><span class="at">active</span>)<span class="op">;</span></span>
<span id="cb2-471"><a href="#cb2-471" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-472"><a href="#cb2-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-473"><a href="#cb2-473" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">draw</span>() {</span>
<span id="cb2-474"><a href="#cb2-474" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear the full logical area</span></span>
<span id="cb2-475"><a href="#cb2-475" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> <span class="st">"#E8E0C5"</span><span class="op">;</span></span>
<span id="cb2-476"><a href="#cb2-476" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">fillRect</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> logicalWidth<span class="op">,</span> logicalHeight)<span class="op">;</span></span>
<span id="cb2-477"><a href="#cb2-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-478"><a href="#cb2-478" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pegs</span></span>
<span id="cb2-479"><a href="#cb2-479" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> <span class="st">"#666"</span><span class="op">;</span></span>
<span id="cb2-480"><a href="#cb2-480" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> row <span class="kw">of</span> pegGrid) {</span>
<span id="cb2-481"><a href="#cb2-481" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> p <span class="kw">of</span> row) {</span>
<span id="cb2-482"><a href="#cb2-482" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">beginPath</span>()<span class="op">;</span></span>
<span id="cb2-483"><a href="#cb2-483" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">arc</span>(p<span class="op">.</span><span class="at">x</span><span class="op">,</span> p<span class="op">.</span><span class="at">y</span><span class="op">,</span> pegRadius<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span><span class="op">*</span><span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb2-484"><a href="#cb2-484" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">fill</span>()<span class="op">;</span></span>
<span id="cb2-485"><a href="#cb2-485" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-486"><a href="#cb2-486" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-487"><a href="#cb2-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-488"><a href="#cb2-488" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Walls</span></span>
<span id="cb2-489"><a href="#cb2-489" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">strokeStyle</span> <span class="op">=</span> <span class="st">"#998866"</span><span class="op">;</span></span>
<span id="cb2-490"><a href="#cb2-490" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-491"><a href="#cb2-491" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;=</span> rows <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb2-492"><a href="#cb2-492" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> x <span class="op">=</span> binsStartX <span class="op">+</span> i <span class="op">*</span> binWidth<span class="op">;</span></span>
<span id="cb2-493"><a href="#cb2-493" aria-hidden="true" tabindex="-1"></a>      ctx<span class="op">.</span><span class="fu">beginPath</span>()<span class="op">;</span></span>
<span id="cb2-494"><a href="#cb2-494" aria-hidden="true" tabindex="-1"></a>      ctx<span class="op">.</span><span class="fu">moveTo</span>(x<span class="op">,</span> wallsTopY)<span class="op">;</span></span>
<span id="cb2-495"><a href="#cb2-495" aria-hidden="true" tabindex="-1"></a>      ctx<span class="op">.</span><span class="fu">lineTo</span>(x<span class="op">,</span> logicalHeight)<span class="op">;</span></span>
<span id="cb2-496"><a href="#cb2-496" aria-hidden="true" tabindex="-1"></a>      ctx<span class="op">.</span><span class="fu">stroke</span>()<span class="op">;</span></span>
<span id="cb2-497"><a href="#cb2-497" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-498"><a href="#cb2-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-499"><a href="#cb2-499" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Active Balls</span></span>
<span id="cb2-500"><a href="#cb2-500" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> <span class="st">"#0033CC"</span><span class="op">;</span></span>
<span id="cb2-501"><a href="#cb2-501" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> b <span class="kw">of</span> balls) {</span>
<span id="cb2-502"><a href="#cb2-502" aria-hidden="true" tabindex="-1"></a>      ctx<span class="op">.</span><span class="fu">beginPath</span>()<span class="op">;</span></span>
<span id="cb2-503"><a href="#cb2-503" aria-hidden="true" tabindex="-1"></a>      ctx<span class="op">.</span><span class="fu">arc</span>(b<span class="op">.</span><span class="at">x</span><span class="op">,</span> b<span class="op">.</span><span class="at">y</span><span class="op">,</span> ballRadius<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span><span class="op">*</span><span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb2-504"><a href="#cb2-504" aria-hidden="true" tabindex="-1"></a>      ctx<span class="op">.</span><span class="fu">fill</span>()<span class="op">;</span></span>
<span id="cb2-505"><a href="#cb2-505" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-506"><a href="#cb2-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-507"><a href="#cb2-507" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Stacked Balls</span></span>
<span id="cb2-508"><a href="#cb2-508" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> bins<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb2-509"><a href="#cb2-509" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> count <span class="op">=</span> bins[i]<span class="op">;</span></span>
<span id="cb2-510"><a href="#cb2-510" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> cx <span class="op">=</span> binsStartX <span class="op">+</span> i <span class="op">*</span> binWidth <span class="op">+</span> binWidth<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-511"><a href="#cb2-511" aria-hidden="true" tabindex="-1"></a>      ctx<span class="op">.</span><span class="at">strokeStyle</span> <span class="op">=</span> <span class="st">"#4d79ff"</span><span class="op">;</span></span>
<span id="cb2-512"><a href="#cb2-512" aria-hidden="true" tabindex="-1"></a>      ctx<span class="op">.</span><span class="at">lineWidth</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb2-513"><a href="#cb2-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-514"><a href="#cb2-514" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> count<span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb2-515"><a href="#cb2-515" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> cy <span class="op">=</span> floorY <span class="op">-</span> j <span class="op">*</span> (ballRadius <span class="op">*</span> <span class="fl">0.6</span>)<span class="op">;</span> </span>
<span id="cb2-516"><a href="#cb2-516" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (cy <span class="op">&lt;</span> wallsTopY) <span class="cf">break</span><span class="op">;</span></span>
<span id="cb2-517"><a href="#cb2-517" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">beginPath</span>()<span class="op">;</span></span>
<span id="cb2-518"><a href="#cb2-518" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">arc</span>(cx<span class="op">,</span> cy<span class="op">,</span> ballRadius<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span><span class="op">*</span><span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb2-519"><a href="#cb2-519" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> <span class="st">"#0033CC"</span><span class="op">;</span></span>
<span id="cb2-520"><a href="#cb2-520" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">fill</span>()<span class="op">;</span></span>
<span id="cb2-521"><a href="#cb2-521" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">stroke</span>()<span class="op">;</span></span>
<span id="cb2-522"><a href="#cb2-522" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-523"><a href="#cb2-523" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-524"><a href="#cb2-524" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-525"><a href="#cb2-525" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Status Text</span></span>
<span id="cb2-526"><a href="#cb2-526" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> <span class="st">"#444"</span><span class="op">;</span></span>
<span id="cb2-527"><a href="#cb2-527" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">font</span> <span class="op">=</span> <span class="st">"bold 14px sans-serif"</span><span class="op">;</span></span>
<span id="cb2-528"><a href="#cb2-528" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">fillText</span>(<span class="vs">`Số viên bi: </span><span class="sc">${</span>spawnedCount<span class="sc">}</span><span class="vs"> / </span><span class="sc">${</span>maxBalls<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">25</span>)<span class="op">;</span></span>
<span id="cb2-529"><a href="#cb2-529" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-530"><a href="#cb2-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-531"><a href="#cb2-531" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> lastTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb2-532"><a href="#cb2-532" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> frameId<span class="op">;</span></span>
<span id="cb2-533"><a href="#cb2-533" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">tick</span>(now) {</span>
<span id="cb2-534"><a href="#cb2-534" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dt <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>((now <span class="op">-</span> lastTime) <span class="op">/</span> <span class="dv">1000</span><span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb2-535"><a href="#cb2-535" aria-hidden="true" tabindex="-1"></a>    lastTime <span class="op">=</span> now<span class="op">;</span></span>
<span id="cb2-536"><a href="#cb2-536" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update</span>(dt)<span class="op">;</span></span>
<span id="cb2-537"><a href="#cb2-537" aria-hidden="true" tabindex="-1"></a>    <span class="fu">draw</span>()<span class="op">;</span></span>
<span id="cb2-538"><a href="#cb2-538" aria-hidden="true" tabindex="-1"></a>    frameId <span class="op">=</span> <span class="fu">requestAnimationFrame</span>(tick)<span class="op">;</span></span>
<span id="cb2-539"><a href="#cb2-539" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-540"><a href="#cb2-540" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-541"><a href="#cb2-541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>()<span class="op">;</span></span>
<span id="cb2-542"><a href="#cb2-542" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tick</span>(lastTime)<span class="op">;</span></span>
<span id="cb2-543"><a href="#cb2-543" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-544"><a href="#cb2-544" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">assign</span>(canvas<span class="op">,</span> {</span>
<span id="cb2-545"><a href="#cb2-545" aria-hidden="true" tabindex="-1"></a>    <span class="dt">remove</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="fu">cancelAnimationFrame</span>(frameId)</span>
<span id="cb2-546"><a href="#cb2-546" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-547"><a href="#cb2-547" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-3" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p><strong>Tại sao lại là phân phối nhị thức?</strong></p>
<ul>
<li>Mỗi lần viên bi chạm vào chiếc đinh, có hai trường hợp xảy ra: viên bi sẽ nảy sang trái hoặc sang phải, xác suất nảy sang mỗi bên là <span class="math inline">\(p = 0.5\)</span>, giống như tung đồng xu. Đây là một phép thử Bernoulli.</li>
<li>Nếu bảng có 10 hàng đinh, viên bi sẽ thực hiện chuỗi Bernoulli có 10 phép thử liên tiếp.</li>
<li>Các ô chứa tương ứng với số lần viên bi nảy về bên phải. Để vào ô giữa, viên bi phải nảy sang bên phải 5 lần (và bên trái 5 lần), để vào ô cuối cùng, viên bi phải nảy sang bên phải 10 lần (và bên trái 0 lần).</li>
</ul>
</section>
<section id="hồi-quy-logistic" class="level4" data-number="4.2.1.3">
<h4 data-number="4.2.1.3" class="anchored" data-anchor-id="hồi-quy-logistic"><span class="header-section-number">4.2.1.3</span> Hồi quy logistic</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(formula, data, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(formula, data, <span class="at">family =</span> <span class="st">"binomial"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Tại sao trong hồi quy logistic lại ghi <code>family = "binomial"</code>?</strong></p>
<p>Ví dụ: Hút thuốc lá có làm tăng nguy cơ ung thư phổi không?</p>
<ul>
<li>Biến độc lập: Số điếu thuốc hút mỗi ngày</li>
<li>Biến phụ thuộc: Tình trạng ung thư phổi (1 = Có bệnh, 0 = Không bệnh)</li>
</ul>
<p>Khi xây dựng mô hình, chúng ta xem xét từng cá nhân trong dữ liệu như một phép thử ngẫu nhiên:</p>
<ul>
<li>Với một người cụ thể (ví dụ: anh A, hút 1 gói/ngày), việc anh ta có bị ung thư hay không giống như việc tung một đồng xu: mặt ngửa (1) là bị ung thư, mặt sấp (0) là không bị ung thư. <strong>Nhưng</strong> xác suất tung ra mặt ngửa của đồng xu này không phải là 0.5, mà phụ thuộc vào việc anh ta hút bao nhiêu thuốc.</li>
<li>Khi chúng ta tiến hành nghiên cứu trên <span class="math inline">\(n\)</span> người, đây là 1 chuỗi Bernoulli, vì vậy có thể chọn phân phối Binomial để mô hình nó.</li>
</ul>
<p>Khai báo <code>family = "binomial"</code> nghĩa là: “Biến kết quả (<span class="math inline">\(Y\)</span>) là đếm số lần thành công (hoặc thất bại) từ các phép thử nhị phân, hãy dùng công thức xác suất của phân phối nhị thức để ước lượng.”</p>
</section>
</section>
<section id="phân-phối-siêu-bội-hypergeometric-distribution" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="phân-phối-siêu-bội-hypergeometric-distribution"><span class="header-section-number">4.2.2</span> Phân phối siêu bội (hypergeometric distribution)</h3>
<p>Tình huống: Bạn có bộ bài 52 lá, trong đó có 4 lá A. Bạn rút 10 lá.</p>
<p>Luật chơi:</p>
<ul>
<li>Số lần thử cố định (<span class="math inline">\(n\)</span>)</li>
<li>Các lần thử phụ thuộc nhau</li>
<li>Lấy mẫu không hoàn lại từ một quần thể hữu hạn (<span class="math inline">\(N\)</span>)</li>
</ul>
<p>Câu hỏi: “Tôi rút được bao nhiêu lá A?”</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb4" data-startfrom="592" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 591;"><span id="cb4-592"><a href="#cb4-592" aria-hidden="true" tabindex="-1"></a>viewof ace_sim_fixed <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">form</span>({</span>
<span id="cb4-593"><a href="#cb4-593" aria-hidden="true" tabindex="-1"></a>  <span class="dt">draw</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">button</span>(<span class="st">"Rút 10 lá"</span>)<span class="op">,</span></span>
<span id="cb4-594"><a href="#cb4-594" aria-hidden="true" tabindex="-1"></a>  <span class="dt">auto</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">toggle</span>({<span class="dt">label</span><span class="op">:</span> <span class="st">"Tự động"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="kw">false</span>})<span class="op">,</span></span>
<span id="cb4-595"><a href="#cb4-595" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reset</span><span class="op">:</span> Inputs<span class="op">.</span><span class="fu">button</span>(<span class="st">"Lại từ đầu"</span>)</span>
<span id="cb4-596"><a href="#cb4-596" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-597"><a href="#cb4-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-598"><a href="#cb4-598" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb4-599"><a href="#cb4-599" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. SETUP</span></span>
<span id="cb4-600"><a href="#cb4-600" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> width <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb4-601"><a href="#cb4-601" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> height <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb4-602"><a href="#cb4-602" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> canvas <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"canvas"</span>)<span class="op">;</span></span>
<span id="cb4-603"><a href="#cb4-603" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> dpr <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">devicePixelRatio</span> <span class="op">||</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-604"><a href="#cb4-604" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">width</span> <span class="op">=</span> width <span class="op">*</span> dpr<span class="op">;</span></span>
<span id="cb4-605"><a href="#cb4-605" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">height</span> <span class="op">=</span> height <span class="op">*</span> dpr<span class="op">;</span></span>
<span id="cb4-606"><a href="#cb4-606" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">width</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>width<span class="sc">}</span><span class="vs">px`</span><span class="op">;</span></span>
<span id="cb4-607"><a href="#cb4-607" aria-hidden="true" tabindex="-1"></a>  canvas<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">height</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>height<span class="sc">}</span><span class="vs">px`</span><span class="op">;</span></span>
<span id="cb4-608"><a href="#cb4-608" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ctx <span class="op">=</span> canvas<span class="op">.</span><span class="fu">getContext</span>(<span class="st">"2d"</span><span class="op">,</span> { <span class="dt">alpha</span><span class="op">:</span> <span class="kw">false</span> })<span class="op">;</span></span>
<span id="cb4-609"><a href="#cb4-609" aria-hidden="true" tabindex="-1"></a>  ctx<span class="op">.</span><span class="fu">scale</span>(dpr<span class="op">,</span> dpr)<span class="op">;</span></span>
<span id="cb4-610"><a href="#cb4-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-611"><a href="#cb4-611" aria-hidden="true" tabindex="-1"></a>  <span class="co">// COLORS</span></span>
<span id="cb4-612"><a href="#cb4-612" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> BG_COLOR <span class="op">=</span> <span class="st">"#f4f6f8"</span><span class="op">;</span> </span>
<span id="cb4-613"><a href="#cb4-613" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> TEXT_COLOR <span class="op">=</span> <span class="st">"#333333"</span><span class="op">;</span></span>
<span id="cb4-614"><a href="#cb4-614" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ACE_COLOR <span class="op">=</span> <span class="st">"#d35400"</span><span class="op">;</span> </span>
<span id="cb4-615"><a href="#cb4-615" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ACE_BG <span class="op">=</span> <span class="st">"#fffbe6"</span><span class="op">;</span> </span>
<span id="cb4-616"><a href="#cb4-616" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CARD_BG_STD <span class="op">=</span> <span class="st">"#ffffff"</span><span class="op">;</span> </span>
<span id="cb4-617"><a href="#cb4-617" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CARD_BORDER <span class="op">=</span> <span class="st">"#cccccc"</span><span class="op">;</span> </span>
<span id="cb4-618"><a href="#cb4-618" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CARD_RED <span class="op">=</span> <span class="st">"#e74c3c"</span><span class="op">;</span></span>
<span id="cb4-619"><a href="#cb4-619" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CARD_BLACK <span class="op">=</span> <span class="st">"#2c3e50"</span><span class="op">;</span></span>
<span id="cb4-620"><a href="#cb4-620" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-621"><a href="#cb4-621" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CHART_THEO <span class="op">=</span> <span class="st">"rgba(0, 0, 0, 0.05)"</span><span class="op">;</span></span>
<span id="cb4-622"><a href="#cb4-622" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CHART_ACTUAL <span class="op">=</span> <span class="st">"#009688"</span><span class="op">;</span> </span>
<span id="cb4-623"><a href="#cb4-623" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CHART_ACTIVE <span class="op">=</span> <span class="st">"#00796b"</span><span class="op">;</span> </span>
<span id="cb4-624"><a href="#cb4-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-625"><a href="#cb4-625" aria-hidden="true" tabindex="-1"></a>  <span class="co">// MATH</span></span>
<span id="cb4-626"><a href="#cb4-626" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">hypergeom</span>(k<span class="op">,</span> N<span class="op">,</span> K<span class="op">,</span> n) {</span>
<span id="cb4-627"><a href="#cb4-627" aria-hidden="true" tabindex="-1"></a>     <span class="kw">function</span> <span class="fu">nCr</span>(n<span class="op">,</span> r) {</span>
<span id="cb4-628"><a href="#cb4-628" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (r <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> r <span class="op">&gt;</span> n) <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-629"><a href="#cb4-629" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> res <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-630"><a href="#cb4-630" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(<span class="kw">let</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>r<span class="op">;</span> i<span class="op">++</span>) res <span class="op">=</span> res <span class="op">*</span> (n <span class="op">-</span> i) <span class="op">/</span> (i <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb4-631"><a href="#cb4-631" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb4-632"><a href="#cb4-632" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb4-633"><a href="#cb4-633" aria-hidden="true" tabindex="-1"></a>     <span class="cf">return</span> (<span class="fu">nCr</span>(K<span class="op">,</span> k) <span class="op">*</span> <span class="fu">nCr</span>(N <span class="op">-</span> K<span class="op">,</span> n <span class="op">-</span> k)) <span class="op">/</span> <span class="fu">nCr</span>(N<span class="op">,</span> n)<span class="op">;</span></span>
<span id="cb4-634"><a href="#cb4-634" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-635"><a href="#cb4-635" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> THEORETICAL <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb4-636"><a href="#cb4-636" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(<span class="kw">let</span> k<span class="op">=</span><span class="dv">0</span><span class="op">;</span> k<span class="op">&lt;=</span><span class="dv">4</span><span class="op">;</span> k<span class="op">++</span>) THEORETICAL[k] <span class="op">=</span> <span class="fu">hypergeom</span>(k<span class="op">,</span> <span class="dv">52</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb4-637"><a href="#cb4-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-638"><a href="#cb4-638" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. STATE (Persistent)</span></span>
<span id="cb4-639"><a href="#cb4-639" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">stateFixed</span>) {</span>
<span id="cb4-640"><a href="#cb4-640" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">stateFixed</span> <span class="op">=</span> {</span>
<span id="cb4-641"><a href="#cb4-641" aria-hidden="true" tabindex="-1"></a>       <span class="dt">counts</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb4-642"><a href="#cb4-642" aria-hidden="true" tabindex="-1"></a>       <span class="dt">totalDeals</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb4-643"><a href="#cb4-643" aria-hidden="true" tabindex="-1"></a>       <span class="dt">lastHand</span><span class="op">:</span> []<span class="op">,</span></span>
<span id="cb4-644"><a href="#cb4-644" aria-hidden="true" tabindex="-1"></a>       <span class="dt">animation</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> </span>
<span id="cb4-645"><a href="#cb4-645" aria-hidden="true" tabindex="-1"></a>       <span class="dt">cooldown</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb4-646"><a href="#cb4-646" aria-hidden="true" tabindex="-1"></a>       <span class="co">// TRACKERS to detect real clicks</span></span>
<span id="cb4-647"><a href="#cb4-647" aria-hidden="true" tabindex="-1"></a>       <span class="dt">lastDrawVal</span><span class="op">:</span> ace_sim_fixed<span class="op">.</span><span class="at">draw</span><span class="op">,</span></span>
<span id="cb4-648"><a href="#cb4-648" aria-hidden="true" tabindex="-1"></a>       <span class="dt">lastResetVal</span><span class="op">:</span> ace_sim_fixed<span class="op">.</span><span class="at">reset</span></span>
<span id="cb4-649"><a href="#cb4-649" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb4-650"><a href="#cb4-650" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-651"><a href="#cb4-651" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> S <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">stateFixed</span><span class="op">;</span></span>
<span id="cb4-652"><a href="#cb4-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-653"><a href="#cb4-653" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. LOGIC</span></span>
<span id="cb4-654"><a href="#cb4-654" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> SUITS <span class="op">=</span> [<span class="st">"♠"</span><span class="op">,</span> <span class="st">"♥"</span><span class="op">,</span> <span class="st">"♣"</span><span class="op">,</span> <span class="st">"♦"</span>]<span class="op">;</span></span>
<span id="cb4-655"><a href="#cb4-655" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> RANKS <span class="op">=</span> [<span class="st">"2"</span><span class="op">,</span><span class="st">"3"</span><span class="op">,</span><span class="st">"4"</span><span class="op">,</span><span class="st">"5"</span><span class="op">,</span><span class="st">"6"</span><span class="op">,</span><span class="st">"7"</span><span class="op">,</span><span class="st">"8"</span><span class="op">,</span><span class="st">"9"</span><span class="op">,</span><span class="st">"10"</span><span class="op">,</span><span class="st">"J"</span><span class="op">,</span><span class="st">"Q"</span><span class="op">,</span><span class="st">"K"</span><span class="op">,</span><span class="st">"A"</span>]<span class="op">;</span></span>
<span id="cb4-656"><a href="#cb4-656" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CARD_W <span class="op">=</span> <span class="dv">30</span><span class="op">;</span></span>
<span id="cb4-657"><a href="#cb4-657" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> CARD_H <span class="op">=</span> <span class="dv">45</span><span class="op">;</span></span>
<span id="cb4-658"><a href="#cb4-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-659"><a href="#cb4-659" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">runDeal</span>() {</span>
<span id="cb4-660"><a href="#cb4-660" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> deck <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb4-661"><a href="#cb4-661" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(<span class="kw">let</span> s <span class="kw">of</span> SUITS) {</span>
<span id="cb4-662"><a href="#cb4-662" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(<span class="kw">let</span> r <span class="kw">of</span> RANKS) {</span>
<span id="cb4-663"><a href="#cb4-663" aria-hidden="true" tabindex="-1"></a>        deck<span class="op">.</span><span class="fu">push</span>({ <span class="dt">rank</span><span class="op">:</span> r<span class="op">,</span> <span class="dt">suit</span><span class="op">:</span> s<span class="op">,</span> <span class="dt">isAce</span><span class="op">:</span> r <span class="op">===</span> <span class="st">"A"</span> })<span class="op">;</span></span>
<span id="cb4-664"><a href="#cb4-664" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-665"><a href="#cb4-665" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-666"><a href="#cb4-666" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(<span class="kw">let</span> i<span class="op">=</span>deck<span class="op">.</span><span class="at">length</span><span class="op">-</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&gt;</span><span class="dv">0</span><span class="op">;</span> i<span class="op">--</span>) {</span>
<span id="cb4-667"><a href="#cb4-667" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> j <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> (i<span class="op">+</span><span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb4-668"><a href="#cb4-668" aria-hidden="true" tabindex="-1"></a>       [deck[i]<span class="op">,</span> deck[j]] <span class="op">=</span> [deck[j]<span class="op">,</span> deck[i]]<span class="op">;</span></span>
<span id="cb4-669"><a href="#cb4-669" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-670"><a href="#cb4-670" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-671"><a href="#cb4-671" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> hand <span class="op">=</span> deck<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb4-672"><a href="#cb4-672" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> aceCount <span class="op">=</span> hand<span class="op">.</span><span class="fu">filter</span>(c <span class="kw">=&gt;</span> c<span class="op">.</span><span class="at">isAce</span>)<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb4-673"><a href="#cb4-673" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-674"><a href="#cb4-674" aria-hidden="true" tabindex="-1"></a>    S<span class="op">.</span><span class="at">counts</span>[aceCount]<span class="op">++;</span></span>
<span id="cb4-675"><a href="#cb4-675" aria-hidden="true" tabindex="-1"></a>    S<span class="op">.</span><span class="at">totalDeals</span><span class="op">++;</span></span>
<span id="cb4-676"><a href="#cb4-676" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-677"><a href="#cb4-677" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startX <span class="op">=</span> (width <span class="op">-</span> (<span class="dv">5</span> <span class="op">*</span> (CARD_W <span class="op">+</span> <span class="dv">8</span>))) <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb4-678"><a href="#cb4-678" aria-hidden="true" tabindex="-1"></a>    S<span class="op">.</span><span class="at">lastHand</span> <span class="op">=</span> hand<span class="op">.</span><span class="fu">map</span>((c<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb4-679"><a href="#cb4-679" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> row <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(i <span class="op">/</span> <span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb4-680"><a href="#cb4-680" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> col <span class="op">=</span> i <span class="op">%</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb4-681"><a href="#cb4-681" aria-hidden="true" tabindex="-1"></a>       <span class="cf">return</span> {</span>
<span id="cb4-682"><a href="#cb4-682" aria-hidden="true" tabindex="-1"></a>         <span class="op">...</span>c<span class="op">,</span></span>
<span id="cb4-683"><a href="#cb4-683" aria-hidden="true" tabindex="-1"></a>         <span class="dt">x</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> </span>
<span id="cb4-684"><a href="#cb4-684" aria-hidden="true" tabindex="-1"></a>         <span class="dt">targetX</span><span class="op">:</span> startX <span class="op">+</span> col <span class="op">*</span> (CARD_W <span class="op">+</span> <span class="dv">8</span>)<span class="op">,</span></span>
<span id="cb4-685"><a href="#cb4-685" aria-hidden="true" tabindex="-1"></a>         <span class="dt">targetY</span><span class="op">:</span> <span class="dv">70</span> <span class="op">+</span> row <span class="op">*</span> (CARD_H <span class="op">+</span> <span class="dv">12</span>)<span class="op">,</span></span>
<span id="cb4-686"><a href="#cb4-686" aria-hidden="true" tabindex="-1"></a>         <span class="dt">t</span><span class="op">:</span> <span class="dv">0</span></span>
<span id="cb4-687"><a href="#cb4-687" aria-hidden="true" tabindex="-1"></a>       }<span class="op">;</span></span>
<span id="cb4-688"><a href="#cb4-688" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb4-689"><a href="#cb4-689" aria-hidden="true" tabindex="-1"></a>    S<span class="op">.</span><span class="at">animation</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-690"><a href="#cb4-690" aria-hidden="true" tabindex="-1"></a>    S<span class="op">.</span><span class="at">cooldown</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> </span>
<span id="cb4-691"><a href="#cb4-691" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-692"><a href="#cb4-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-693"><a href="#cb4-693" aria-hidden="true" tabindex="-1"></a>  <span class="co">// --- BUTTON HANDLING (The Fix) ---</span></span>
<span id="cb4-694"><a href="#cb4-694" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-695"><a href="#cb4-695" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Detect RESET Click</span></span>
<span id="cb4-696"><a href="#cb4-696" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ace_sim_fixed<span class="op">.</span><span class="at">reset</span> <span class="op">&gt;</span> S<span class="op">.</span><span class="at">lastResetVal</span>) {</span>
<span id="cb4-697"><a href="#cb4-697" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">counts</span> <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb4-698"><a href="#cb4-698" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">totalDeals</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-699"><a href="#cb4-699" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">lastHand</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb4-700"><a href="#cb4-700" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">animation</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-701"><a href="#cb4-701" aria-hidden="true" tabindex="-1"></a>     <span class="co">// Update tracker so we don't reset again until next click</span></span>
<span id="cb4-702"><a href="#cb4-702" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">lastResetVal</span> <span class="op">=</span> ace_sim_fixed<span class="op">.</span><span class="at">reset</span><span class="op">;</span></span>
<span id="cb4-703"><a href="#cb4-703" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-704"><a href="#cb4-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-705"><a href="#cb4-705" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Detect DRAW Click</span></span>
<span id="cb4-706"><a href="#cb4-706" aria-hidden="true" tabindex="-1"></a>  <span class="co">// We only run deal if the button count is HIGHER than last time</span></span>
<span id="cb4-707"><a href="#cb4-707" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ace_sim_fixed<span class="op">.</span><span class="at">draw</span> <span class="op">&gt;</span> S<span class="op">.</span><span class="at">lastDrawVal</span>) {</span>
<span id="cb4-708"><a href="#cb4-708" aria-hidden="true" tabindex="-1"></a>     <span class="fu">runDeal</span>()<span class="op">;</span></span>
<span id="cb4-709"><a href="#cb4-709" aria-hidden="true" tabindex="-1"></a>     S<span class="op">.</span><span class="at">lastDrawVal</span> <span class="op">=</span> ace_sim_fixed<span class="op">.</span><span class="at">draw</span><span class="op">;</span></span>
<span id="cb4-710"><a href="#cb4-710" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-711"><a href="#cb4-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-712"><a href="#cb4-712" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. RENDER LOOP</span></span>
<span id="cb4-713"><a href="#cb4-713" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">update</span>() {</span>
<span id="cb4-714"><a href="#cb4-714" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> viewof ace_sim_fixed<span class="op">;</span></span>
<span id="cb4-715"><a href="#cb4-715" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> checkbox <span class="op">=</span> form<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"input[type=checkbox]"</span>)<span class="op">;</span></span>
<span id="cb4-716"><a href="#cb4-716" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> isAutoRunning <span class="op">=</span> checkbox <span class="op">?</span> checkbox<span class="op">.</span><span class="at">checked</span> <span class="op">:</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-717"><a href="#cb4-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-718"><a href="#cb4-718" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (S<span class="op">.</span><span class="at">animation</span> <span class="op">===</span> <span class="dv">1</span>) {</span>
<span id="cb4-719"><a href="#cb4-719" aria-hidden="true" tabindex="-1"></a>       <span class="kw">let</span> done <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb4-720"><a href="#cb4-720" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> (<span class="kw">let</span> c <span class="kw">of</span> S<span class="op">.</span><span class="at">lastHand</span>) {</span>
<span id="cb4-721"><a href="#cb4-721" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (c<span class="op">.</span><span class="at">t</span> <span class="op">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb4-722"><a href="#cb4-722" aria-hidden="true" tabindex="-1"></a>             c<span class="op">.</span><span class="at">t</span> <span class="op">+=</span> <span class="fl">0.08</span><span class="op">;</span> </span>
<span id="cb4-723"><a href="#cb4-723" aria-hidden="true" tabindex="-1"></a>             <span class="cf">if</span> (c<span class="op">.</span><span class="at">t</span> <span class="op">&gt;</span> <span class="dv">1</span>) c<span class="op">.</span><span class="at">t</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-724"><a href="#cb4-724" aria-hidden="true" tabindex="-1"></a>             c<span class="op">.</span><span class="at">x</span> <span class="op">=</span> <span class="dv">20</span> <span class="op">+</span> (c<span class="op">.</span><span class="at">targetX</span> <span class="op">-</span> <span class="dv">20</span>) <span class="op">*</span> c<span class="op">.</span><span class="at">t</span><span class="op">;</span></span>
<span id="cb4-725"><a href="#cb4-725" aria-hidden="true" tabindex="-1"></a>             c<span class="op">.</span><span class="at">y</span> <span class="op">=</span> <span class="dv">20</span> <span class="op">+</span> (c<span class="op">.</span><span class="at">targetY</span> <span class="op">-</span> <span class="dv">20</span>) <span class="op">*</span> c<span class="op">.</span><span class="at">t</span><span class="op">;</span></span>
<span id="cb4-726"><a href="#cb4-726" aria-hidden="true" tabindex="-1"></a>             done <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-727"><a href="#cb4-727" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb4-728"><a href="#cb4-728" aria-hidden="true" tabindex="-1"></a>       }</span>
<span id="cb4-729"><a href="#cb4-729" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span> (done) S<span class="op">.</span><span class="at">animation</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-730"><a href="#cb4-730" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (isAutoRunning) {</span>
<span id="cb4-731"><a href="#cb4-731" aria-hidden="true" tabindex="-1"></a>       S<span class="op">.</span><span class="at">cooldown</span><span class="op">++;</span></span>
<span id="cb4-732"><a href="#cb4-732" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span> (S<span class="op">.</span><span class="at">cooldown</span> <span class="op">&gt;</span> <span class="dv">100</span>) <span class="fu">runDeal</span>()<span class="op">;</span> </span>
<span id="cb4-733"><a href="#cb4-733" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-734"><a href="#cb4-734" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-735"><a href="#cb4-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-736"><a href="#cb4-736" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">draw</span>() {</span>
<span id="cb4-737"><a href="#cb4-737" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> viewof ace_sim_fixed<span class="op">;</span></span>
<span id="cb4-738"><a href="#cb4-738" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> checkbox <span class="op">=</span> form<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"input[type=checkbox]"</span>)<span class="op">;</span></span>
<span id="cb4-739"><a href="#cb4-739" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> isAutoRunning <span class="op">=</span> checkbox <span class="op">?</span> checkbox<span class="op">.</span><span class="at">checked</span> <span class="op">:</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-740"><a href="#cb4-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-741"><a href="#cb4-741" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> BG_COLOR<span class="op">;</span></span>
<span id="cb4-742"><a href="#cb4-742" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">fillRect</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> width<span class="op">,</span> height)<span class="op">;</span></span>
<span id="cb4-743"><a href="#cb4-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-744"><a href="#cb4-744" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Text</span></span>
<span id="cb4-745"><a href="#cb4-745" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">textAlign</span> <span class="op">=</span> <span class="st">"left"</span><span class="op">;</span></span>
<span id="cb4-746"><a href="#cb4-746" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> TEXT_COLOR<span class="op">;</span></span>
<span id="cb4-747"><a href="#cb4-747" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">font</span> <span class="op">=</span> <span class="st">"14px sans-serif"</span><span class="op">;</span></span>
<span id="cb4-748"><a href="#cb4-748" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">fillText</span>(<span class="vs">`Lần rút thứ: </span><span class="sc">${</span>S<span class="op">.</span><span class="at">totalDeals</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="dv">60</span><span class="op">,</span> <span class="dv">30</span>)<span class="op">;</span></span>
<span id="cb4-749"><a href="#cb4-749" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-750"><a href="#cb4-750" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (isAutoRunning) {</span>
<span id="cb4-751"><a href="#cb4-751" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> CHART_ACTUAL<span class="op">;</span></span>
<span id="cb4-752"><a href="#cb4-752" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">fillText</span>(<span class="st">"● Tự động"</span><span class="op">,</span> <span class="dv">60</span><span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span></span>
<span id="cb4-753"><a href="#cb4-753" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (S<span class="op">.</span><span class="at">lastHand</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-754"><a href="#cb4-754" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> aces <span class="op">=</span> S<span class="op">.</span><span class="at">lastHand</span><span class="op">.</span><span class="fu">filter</span>(c<span class="kw">=&gt;</span>c<span class="op">.</span><span class="at">isAce</span>)<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb4-755"><a href="#cb4-755" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> ACE_COLOR<span class="op">;</span></span>
<span id="cb4-756"><a href="#cb4-756" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">fillText</span>(<span class="vs">`Kết quả: </span><span class="sc">${</span>aces<span class="sc">}</span><span class="vs"> lá A`</span><span class="op">,</span> <span class="dv">60</span><span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span></span>
<span id="cb4-757"><a href="#cb4-757" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-758"><a href="#cb4-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-759"><a href="#cb4-759" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Deck</span></span>
<span id="cb4-760"><a href="#cb4-760" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> CARD_BG_STD<span class="op">;</span></span>
<span id="cb4-761"><a href="#cb4-761" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">strokeStyle</span> <span class="op">=</span> CARD_BORDER<span class="op">;</span></span>
<span id="cb4-762"><a href="#cb4-762" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(<span class="kw">let</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">3</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb4-763"><a href="#cb4-763" aria-hidden="true" tabindex="-1"></a>      ctx<span class="op">.</span><span class="fu">fillRect</span>(<span class="dv">20</span><span class="op">-</span>i<span class="op">,</span> <span class="dv">20</span><span class="op">-</span>i<span class="op">,</span> CARD_W<span class="op">,</span> CARD_H)<span class="op">;</span></span>
<span id="cb4-764"><a href="#cb4-764" aria-hidden="true" tabindex="-1"></a>      ctx<span class="op">.</span><span class="fu">strokeRect</span>(<span class="dv">20</span><span class="op">-</span>i<span class="op">,</span> <span class="dv">20</span><span class="op">-</span>i<span class="op">,</span> CARD_W<span class="op">,</span> CARD_H)<span class="op">;</span></span>
<span id="cb4-765"><a href="#cb4-765" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-766"><a href="#cb4-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-767"><a href="#cb4-767" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Hand</span></span>
<span id="cb4-768"><a href="#cb4-768" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> c <span class="kw">of</span> S<span class="op">.</span><span class="at">lastHand</span>) {</span>
<span id="cb4-769"><a href="#cb4-769" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> c<span class="op">.</span><span class="at">isAce</span> <span class="op">?</span> ACE_BG <span class="op">:</span> CARD_BG_STD<span class="op">;</span></span>
<span id="cb4-770"><a href="#cb4-770" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">fillRect</span>(c<span class="op">.</span><span class="at">x</span><span class="op">,</span> c<span class="op">.</span><span class="at">y</span><span class="op">,</span> CARD_W<span class="op">,</span> CARD_H)<span class="op">;</span></span>
<span id="cb4-771"><a href="#cb4-771" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-772"><a href="#cb4-772" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-773"><a href="#cb4-773" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="at">strokeStyle</span> <span class="op">=</span> c<span class="op">.</span><span class="at">isAce</span> <span class="op">?</span> ACE_COLOR <span class="op">:</span> CARD_BORDER<span class="op">;</span></span>
<span id="cb4-774"><a href="#cb4-774" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">strokeRect</span>(c<span class="op">.</span><span class="at">x</span><span class="op">,</span> c<span class="op">.</span><span class="at">y</span><span class="op">,</span> CARD_W<span class="op">,</span> CARD_H)<span class="op">;</span></span>
<span id="cb4-775"><a href="#cb4-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-776"><a href="#cb4-776" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> isRed <span class="op">=</span> (c<span class="op">.</span><span class="at">suit</span> <span class="op">===</span> <span class="st">"♥"</span> <span class="op">||</span> c<span class="op">.</span><span class="at">suit</span> <span class="op">===</span> <span class="st">"♦"</span>)<span class="op">;</span></span>
<span id="cb4-777"><a href="#cb4-777" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> c<span class="op">.</span><span class="at">isAce</span> <span class="op">?</span> ACE_COLOR <span class="op">:</span> (isRed <span class="op">?</span> CARD_RED <span class="op">:</span> CARD_BLACK)<span class="op">;</span></span>
<span id="cb4-778"><a href="#cb4-778" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-779"><a href="#cb4-779" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="at">textAlign</span> <span class="op">=</span> <span class="st">"left"</span><span class="op">;</span> ctx<span class="op">.</span><span class="at">textBaseline</span> <span class="op">=</span> <span class="st">"top"</span><span class="op">;</span></span>
<span id="cb4-780"><a href="#cb4-780" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="at">font</span> <span class="op">=</span> <span class="st">"bold 14px sans-serif"</span><span class="op">;</span></span>
<span id="cb4-781"><a href="#cb4-781" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">fillText</span>(c<span class="op">.</span><span class="at">rank</span><span class="op">,</span> c<span class="op">.</span><span class="at">x</span> <span class="op">+</span> <span class="dv">3</span><span class="op">,</span> c<span class="op">.</span><span class="at">y</span> <span class="op">+</span> <span class="dv">4</span>)<span class="op">;</span></span>
<span id="cb4-782"><a href="#cb4-782" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="at">font</span> <span class="op">=</span> <span class="st">"16px sans-serif"</span><span class="op">;</span></span>
<span id="cb4-783"><a href="#cb4-783" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">.</span><span class="fu">fillText</span>(c<span class="op">.</span><span class="at">suit</span><span class="op">,</span> c<span class="op">.</span><span class="at">x</span> <span class="op">+</span> <span class="dv">3</span><span class="op">,</span> c<span class="op">.</span><span class="at">y</span> <span class="op">+</span> <span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb4-784"><a href="#cb4-784" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-785"><a href="#cb4-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-786"><a href="#cb4-786" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Chart</span></span>
<span id="cb4-787"><a href="#cb4-787" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> chartY <span class="op">=</span> <span class="dv">340</span><span class="op">;</span> </span>
<span id="cb4-788"><a href="#cb4-788" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> chartH <span class="op">=</span> <span class="dv">80</span><span class="op">;</span> </span>
<span id="cb4-789"><a href="#cb4-789" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> chartX <span class="op">=</span> <span class="dv">40</span><span class="op">;</span></span>
<span id="cb4-790"><a href="#cb4-790" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> barW <span class="op">=</span> <span class="dv">40</span><span class="op">;</span></span>
<span id="cb4-791"><a href="#cb4-791" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> gap <span class="op">=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb4-792"><a href="#cb4-792" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-793"><a href="#cb4-793" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">beginPath</span>()<span class="op">;</span></span>
<span id="cb4-794"><a href="#cb4-794" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">strokeStyle</span> <span class="op">=</span> <span class="st">"#999999"</span><span class="op">;</span></span>
<span id="cb4-795"><a href="#cb4-795" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-796"><a href="#cb4-796" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">moveTo</span>(chartX <span class="op">-</span> <span class="dv">10</span><span class="op">,</span> chartY)<span class="op">;</span></span>
<span id="cb4-797"><a href="#cb4-797" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">lineTo</span>(width <span class="op">-</span> <span class="dv">20</span><span class="op">,</span> chartY)<span class="op">;</span></span>
<span id="cb4-798"><a href="#cb4-798" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">stroke</span>()<span class="op">;</span></span>
<span id="cb4-799"><a href="#cb4-799" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-800"><a href="#cb4-800" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> TEXT_COLOR<span class="op">;</span></span>
<span id="cb4-801"><a href="#cb4-801" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">font</span> <span class="op">=</span> <span class="st">"12px sans-serif"</span><span class="op">;</span></span>
<span id="cb4-802"><a href="#cb4-802" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="at">textAlign</span> <span class="op">=</span> <span class="st">"center"</span><span class="op">;</span></span>
<span id="cb4-803"><a href="#cb4-803" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">.</span><span class="fu">fillText</span>(<span class="st">"Số lá A rút được (k)"</span><span class="op">,</span> width<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">10</span><span class="op">,</span> chartY <span class="op">+</span> <span class="dv">35</span>)<span class="op">;</span></span>
<span id="cb4-804"><a href="#cb4-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-805"><a href="#cb4-805" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> activeAces <span class="op">=</span> S<span class="op">.</span><span class="at">lastHand</span><span class="op">.</span><span class="fu">filter</span>(c<span class="kw">=&gt;</span>c<span class="op">.</span><span class="at">isAce</span>)<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb4-806"><a href="#cb4-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-807"><a href="#cb4-807" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> k <span class="op">&lt;=</span> <span class="dv">4</span><span class="op">;</span> k<span class="op">++</span>) {</span>
<span id="cb4-808"><a href="#cb4-808" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> x <span class="op">=</span> chartX <span class="op">+</span> k <span class="op">*</span> (barW <span class="op">+</span> gap)<span class="op">;</span></span>
<span id="cb4-809"><a href="#cb4-809" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb4-810"><a href="#cb4-810" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> prob <span class="op">=</span> THEORETICAL[k]<span class="op">;</span></span>
<span id="cb4-811"><a href="#cb4-811" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> scaleH <span class="op">=</span> chartH <span class="op">/</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb4-812"><a href="#cb4-812" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> theoH <span class="op">=</span> prob <span class="op">*</span> scaleH<span class="op">;</span></span>
<span id="cb4-813"><a href="#cb4-813" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> CHART_THEO<span class="op">;</span></span>
<span id="cb4-814"><a href="#cb4-814" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">fillRect</span>(x<span class="op">,</span> chartY <span class="op">-</span> theoH<span class="op">,</span> barW<span class="op">,</span> theoH)<span class="op">;</span></span>
<span id="cb4-815"><a href="#cb4-815" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb4-816"><a href="#cb4-816" aria-hidden="true" tabindex="-1"></a>       <span class="kw">let</span> count <span class="op">=</span> S<span class="op">.</span><span class="at">counts</span>[k]<span class="op">;</span></span>
<span id="cb4-817"><a href="#cb4-817" aria-hidden="true" tabindex="-1"></a>       <span class="kw">let</span> pct <span class="op">=</span> S<span class="op">.</span><span class="at">totalDeals</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> count <span class="op">/</span> S<span class="op">.</span><span class="at">totalDeals</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-818"><a href="#cb4-818" aria-hidden="true" tabindex="-1"></a>       <span class="kw">let</span> barH <span class="op">=</span> pct <span class="op">*</span> scaleH<span class="op">;</span></span>
<span id="cb4-819"><a href="#cb4-819" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb4-820"><a href="#cb4-820" aria-hidden="true" tabindex="-1"></a>       <span class="kw">const</span> isActive <span class="op">=</span> (S<span class="op">.</span><span class="at">animation</span> <span class="op">===</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> S<span class="op">.</span><span class="at">totalDeals</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> k <span class="op">===</span> activeAces)<span class="op">;</span></span>
<span id="cb4-821"><a href="#cb4-821" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> isActive <span class="op">?</span> CHART_ACTIVE <span class="op">:</span> CHART_ACTUAL<span class="op">;</span></span>
<span id="cb4-822"><a href="#cb4-822" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">fillRect</span>(x<span class="op">,</span> chartY <span class="op">-</span> barH<span class="op">,</span> barW<span class="op">,</span> barH)<span class="op">;</span></span>
<span id="cb4-823"><a href="#cb4-823" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb4-824"><a href="#cb4-824" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> TEXT_COLOR<span class="op">;</span></span>
<span id="cb4-825"><a href="#cb4-825" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="at">font</span> <span class="op">=</span> <span class="st">"bold 12px sans-serif"</span><span class="op">;</span></span>
<span id="cb4-826"><a href="#cb4-826" aria-hidden="true" tabindex="-1"></a>       ctx<span class="op">.</span><span class="fu">fillText</span>(k<span class="op">,</span> x <span class="op">+</span> barW<span class="op">/</span><span class="dv">2</span><span class="op">,</span> chartY <span class="op">+</span> <span class="dv">15</span>)<span class="op">;</span></span>
<span id="cb4-827"><a href="#cb4-827" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb4-828"><a href="#cb4-828" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span> (pct <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-829"><a href="#cb4-829" aria-hidden="true" tabindex="-1"></a>          ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> isActive <span class="op">?</span> CHART_ACTIVE <span class="op">:</span> TEXT_COLOR<span class="op">;</span></span>
<span id="cb4-830"><a href="#cb4-830" aria-hidden="true" tabindex="-1"></a>          ctx<span class="op">.</span><span class="at">font</span> <span class="op">=</span> <span class="st">"10px sans-serif"</span><span class="op">;</span></span>
<span id="cb4-831"><a href="#cb4-831" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> labelY <span class="op">=</span> barH <span class="op">&gt;</span> <span class="dv">20</span> <span class="op">?</span> chartY <span class="op">-</span> barH <span class="op">+</span> <span class="dv">12</span> <span class="op">:</span> chartY <span class="op">-</span> barH <span class="op">-</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb4-832"><a href="#cb4-832" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (isActive <span class="op">&amp;&amp;</span> barH <span class="op">&gt;</span> <span class="dv">20</span>) ctx<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> <span class="st">"#ffffff"</span><span class="op">;</span></span>
<span id="cb4-833"><a href="#cb4-833" aria-hidden="true" tabindex="-1"></a>          ctx<span class="op">.</span><span class="fu">fillText</span>((pct<span class="op">*</span><span class="dv">100</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">0</span>)<span class="op">+</span><span class="st">"%"</span><span class="op">,</span> x<span class="op">+</span>barW<span class="op">/</span><span class="dv">2</span><span class="op">,</span> labelY)<span class="op">;</span></span>
<span id="cb4-834"><a href="#cb4-834" aria-hidden="true" tabindex="-1"></a>       }</span>
<span id="cb4-835"><a href="#cb4-835" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-836"><a href="#cb4-836" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-837"><a href="#cb4-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-838"><a href="#cb4-838" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> frameId<span class="op">;</span></span>
<span id="cb4-839"><a href="#cb4-839" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">tick</span>() {</span>
<span id="cb4-840"><a href="#cb4-840" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update</span>()<span class="op">;</span></span>
<span id="cb4-841"><a href="#cb4-841" aria-hidden="true" tabindex="-1"></a>    <span class="fu">draw</span>()<span class="op">;</span></span>
<span id="cb4-842"><a href="#cb4-842" aria-hidden="true" tabindex="-1"></a>    frameId <span class="op">=</span> <span class="fu">requestAnimationFrame</span>(tick)<span class="op">;</span></span>
<span id="cb4-843"><a href="#cb4-843" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-844"><a href="#cb4-844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tick</span>()<span class="op">;</span></span>
<span id="cb4-845"><a href="#cb4-845" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-846"><a href="#cb4-846" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">assign</span>(canvas<span class="op">,</span> {</span>
<span id="cb4-847"><a href="#cb4-847" aria-hidden="true" tabindex="-1"></a>    <span class="dt">remove</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="fu">cancelAnimationFrame</span>(frameId)</span>
<span id="cb4-848"><a href="#cb4-848" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb4-849"><a href="#cb4-849" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-3-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-3-2" data-nodetype="expression">

</div>
</div>
</div>
</div>
</section>
</section>
<section id="đếm-số-lần-thử" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="đếm-số-lần-thử"><span class="header-section-number">4.3</span> Đếm số lần thử</h2>
<p>Chúng ta quyết định trước phần thưởng mình muốn đạt được (<span class="math inline">\(k\)</span> thành công), và đếm xem phải tốn bao nhiêu công sức (<span class="math inline">\(n\)</span> lần thử) để đạt được nó. Nhánh này mô hình hóa sự “kiên trì” hoặc “sức chịu đựng”.</p>
<section id="phân-phối-hình-học-geometric-distribution" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="phân-phối-hình-học-geometric-distribution"><span class="header-section-number">4.3.1</span> Phân phối hình học (geometric distribution)</h3>
<p>Tình huống: Một gia đình phong kiến trọng nam khinh nữ muốn có một đứa con trai, họ cứ sinh con cho đến khi có con trai thì thôi</p>
<p>Câu hỏi: Họ phải sinh bao nhiêu con cho đến khi có con trai?</p>
<p>Đặc tính: Không có bộ nhớ (Memoryless). Dù đã sinh 10 con gái liên tiếp, xác suất đứa tiếp theo là trai vẫn y như lúc bắt đầu.</p>
</section>
<section id="phân-phối-nhị-thức-âm-negative-binomial-distribution" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="phân-phối-nhị-thức-âm-negative-binomial-distribution"><span class="header-section-number">4.3.2</span> Phân phối nhị thức âm (negative binomial distribution)</h3>
<p>Tình huống: Gia đình phong kiến đã sinh được con trai nhưng vẫn muốn có con trai nữa, thầy bói nói nhà phải có 3 đứa con trai mới giàu được</p>
<p>Câu hỏi: Họ sẽ sinh bao nhiêu con trước khi có được đứa con trai thứ 3?</p>
<p>Về lý thuyết, đây là tổng của <span class="math inline">\(k\)</span> biến thuộc phân phối hình học.</p>
<p>Trong sinh học thực tế (ví dụ: đếm số ký sinh trùng, ấu trùng muỗi), phương sai thường lớn hơn trung bình rất nhiều (do hiện tượng tụ đám/clumping). Phân phối Nhị thức Âm khớp với kiểu dữ liệu này tốt hơn nhiều so với Poisson hay Nhị thức.</p>
</section>
</section>
<section id="đếm-sự-kiện-khi-biết-tốc-độ-trung-bình" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="đếm-sự-kiện-khi-biết-tốc-độ-trung-bình"><span class="header-section-number">4.4</span> Đếm sự kiện khi biết tốc độ trung bình</h2>
<section id="phân-phối-poisson" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="phân-phối-poisson"><span class="header-section-number">4.4.1</span> Phân phối Poisson</h3>
<p>Poisson là giới hạn của nhị thức khi <span class="math inline">\(n \to \infty\)</span> và <span class="math inline">\(p \to 0\)</span>, sao cho <span class="math inline">\(np = \lambda\)</span></p>
<p>Các phân phối phức tạp có thể được tạo ra bằng cách cộng các phân phối đơn giản:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Nếu cộng</th>
<th>Sẽ có</th>
<th>Điều kiện</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Nhiều Bernoulli</td>
<td>Nhị thức</td>
<td>Cùng <span class="math inline">\(p\)</span>.</td>
</tr>
<tr class="even">
<td>Nhiều Nhị thức</td>
<td>Nhị thức</td>
<td><span class="math inline">\(X+Y \sim \text{Bin}(n+m, p)\)</span></td>
</tr>
<tr class="odd">
<td>Nhiều Hình học</td>
<td>Nhị thức âm</td>
<td>Chờ <span class="math inline">\(k\)</span> thành công thực chất là chờ 1 thành công, lặp lại <span class="math inline">\(k\)</span> lần</td>
</tr>
<tr class="even">
<td>Nhiều Nhị thức âm</td>
<td>Nhị thức âm</td>
<td><span class="math inline">\(X+Y \sim \text{NB}(r_1+r_2, p)\)</span></td>
</tr>
<tr class="odd">
<td>Nhiều Poisson</td>
<td>Poisson</td>
<td><span class="math inline">\(X+Y \sim \text{Pois}(\lambda_1 + \lambda_2)\)</span></td>
</tr>
</tbody>
</table>


</section>
</section>

</main> <!-- /main -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W3sibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InZpZXdvZiBjb2luX3NpbV9yZXNldF9wID0gSW5wdXRzLmZvcm0oe1xuICBwOiBJbnB1dHMucmFuZ2UoWzAuMDEsIDAuOTldLCB7dmFsdWU6IDAuNSwgc3RlcDogMC4wMSwgbGFiZWw6IFwiWMOhYyBzdeG6pXQgbeG6t3Qgbmfhu61hIChwKVwifSksXG4gIGZsaXA6IElucHV0cy5idXR0b24oXCJUdW5nIDEwIGzhuqduXCIpLFxuICBhdXRvOiBJbnB1dHMudG9nZ2xlKHtsYWJlbDogXCJU4buxIMSR4buZbmdcIiwgdmFsdWU6IGZhbHNlfSksXG4gIHJlc2V0OiBJbnB1dHMuYnV0dG9uKFwiTOG6oWkgdOG7qyDEkeG6p3VcIilcbn0pXG5cbntcbiAgLy8gMS4gU0VUVVBcbiAgY29uc3Qgd2lkdGggPSA0NTA7XG4gIGNvbnN0IGhlaWdodCA9IDQwMDtcbiAgY29uc3QgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImNhbnZhc1wiKTtcbiAgY29uc3QgZHByID0gd2luZG93LmRldmljZVBpeGVsUmF0aW8gfHwgMTtcbiAgY2FudmFzLndpZHRoID0gd2lkdGggKiBkcHI7XG4gIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQgKiBkcHI7XG4gIGNhbnZhcy5zdHlsZS53aWR0aCA9IGAke3dpZHRofXB4YDtcbiAgY2FudmFzLnN0eWxlLmhlaWdodCA9IGAke2hlaWdodH1weGA7XG4gIFxuICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dChcIjJkXCIsIHsgYWxwaGE6IGZhbHNlIH0pO1xuICBjdHguc2NhbGUoZHByLCBkcHIpO1xuXG4gIC8vIENPTlNUQU5UU1xuICBjb25zdCBOID0gMTA7IFxuICBcbiAgLy8gQ09MT1JTXG4gIGNvbnN0IEJHX0NPTE9SID0gXCIjZjhmOWZhXCI7IFxuICBjb25zdCBURVhUX0NPTE9SID0gXCIjMmMzZTUwXCI7XG4gIGNvbnN0IEhFQURfQ09MT1IgPSBcIiNmMWM0MGZcIjsgXG4gIGNvbnN0IEhFQURfQk9SREVSID0gXCIjZDRhYzBkXCI7XG4gIGNvbnN0IFRBSUxfQ09MT1IgPSBcIiNiZGMzYzdcIjsgXG4gIGNvbnN0IFRBSUxfQk9SREVSID0gXCIjOTVhNWE2XCI7XG4gIGNvbnN0IENIQVJUX0JBUiA9IFwiIzM0OThkYlwiOyBcbiAgY29uc3QgQ0hBUlRfQUNUSVZFID0gXCIjMjk4MGI5XCI7XG4gIGNvbnN0IENIQVJUX1RIRU8gPSBcInJnYmEoNDQsIDYyLCA4MCwgMC4xKVwiOyBcblxuICAvLyBNQVRIIEhFTFBFUlxuICBmdW5jdGlvbiBiaW5vbWlhbChrLCBuLCBwKSB7XG4gICAgZnVuY3Rpb24gbkNyKG4sIHIpIHtcbiAgICAgICAgaWYgKHIgPCAwIHx8IHIgPiBuKSByZXR1cm4gMDtcbiAgICAgICAgbGV0IHJlcyA9IDE7XG4gICAgICAgIGZvcihsZXQgaT0wOyBpPHI7IGkrKykgcmVzID0gcmVzICogKG4gLSBpKSAvIChpICsgMSk7XG4gICAgICAgIHJldHVybiByZXM7XG4gICAgfVxuICAgIHJldHVybiBuQ3IobiwgaykgKiBNYXRoLnBvdyhwLCBrKSAqIE1hdGgucG93KDEgLSBwLCBuIC0gayk7XG4gIH1cblxuICAvLyAyLiBTVEFURVxuICBpZiAoIXRoaXMuc3RhdGVDb2luUmVzZXQpIHtcbiAgICB0aGlzLnN0YXRlQ29pblJlc2V0ID0ge1xuICAgICAgIGhpc3Rvcnk6IFtdLCBcbiAgICAgICBjb3VudHM6IHt9LCAgXG4gICAgICAgdG90YWxGbGlwczogMCxcbiAgICAgICBjdXJyZW50UmVzdWx0OiBbXSwgXG4gICAgICAgYW5pbWF0aW9uOiAwLCBcbiAgICAgICBjb29sZG93bjogMCxcbiAgICAgICBsYXN0RmxpcFZhbDogY29pbl9zaW1fcmVzZXRfcC5mbGlwLFxuICAgICAgIGxhc3RSZXNldFZhbDogY29pbl9zaW1fcmVzZXRfcC5yZXNldCxcbiAgICAgICBsYXN0UDogY29pbl9zaW1fcmVzZXRfcC5wIC8vIFRyYWNrIFAgdG8gZGV0ZWN0IGNoYW5nZXNcbiAgICB9O1xuICAgIGZvcihsZXQgaT0wOyBpPD1OOyBpKyspIHRoaXMuc3RhdGVDb2luUmVzZXQuY291bnRzW2ldID0gMDtcbiAgfVxuICBjb25zdCBTID0gdGhpcy5zdGF0ZUNvaW5SZXNldDtcbiAgXG4gIC8vIEN1cnJlbnQgUFxuICBjb25zdCBQID0gY29pbl9zaW1fcmVzZXRfcC5wO1xuXG4gIC8vIDMuIExPR0lDXG4gIFxuICAvLyBIZWxwZXIgdG8gY2xlYXIgZGF0YVxuICBmdW5jdGlvbiBkb1Jlc2V0KCkge1xuICAgICBTLmhpc3RvcnkgPSBbXTtcbiAgICAgZm9yKGxldCBpPTA7IGk8PU47IGkrKykgUy5jb3VudHNbaV0gPSAwO1xuICAgICBTLnRvdGFsRmxpcHMgPSAwO1xuICAgICBTLmN1cnJlbnRSZXN1bHQgPSBbXTtcbiAgICAgUy5hbmltYXRpb24gPSAwO1xuICB9XG5cbiAgLy8gQS4gRXhwbGljaXQgUmVzZXQgQnV0dG9uXG4gIGlmIChjb2luX3NpbV9yZXNldF9wLnJlc2V0ID4gUy5sYXN0UmVzZXRWYWwpIHtcbiAgICAgZG9SZXNldCgpO1xuICAgICBTLmxhc3RSZXNldFZhbCA9IGNvaW5fc2ltX3Jlc2V0X3AucmVzZXQ7XG4gIH1cblxuICAvLyBCLiBBdXRvLVJlc2V0IG9uIFByb2JhYmlsaXR5IENoYW5nZVxuICAvLyBJZiB0aGUgdXNlciBtb3ZlZCB0aGUgc2xpZGVyLCB3ZSB3aXBlIHRoZSBkYXRhIGltbWVkaWF0ZWx5LlxuICBpZiAoUCAhPT0gUy5sYXN0UCkge1xuICAgICBkb1Jlc2V0KCk7XG4gICAgIFMubGFzdFAgPSBQO1xuICB9XG5cbiAgLy8gRmxpcCBGdW5jdGlvblxuICBmdW5jdGlvbiBydW5GbGlwKCkge1xuICAgICBsZXQgaGVhZHMgPSAwO1xuICAgICBjb25zdCByZXMgPSBbXTtcbiAgICAgZm9yKGxldCBpPTA7IGk8TjsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGlzSGVhZCA9IE1hdGgucmFuZG9tKCkgPCBQO1xuICAgICAgICByZXMucHVzaChpc0hlYWQgPyAxIDogMCk7XG4gICAgICAgIGlmIChpc0hlYWQpIGhlYWRzKys7XG4gICAgIH1cbiAgICAgXG4gICAgIGNvbnN0IGNvaW5TaXplID0gMjg7XG4gICAgIGNvbnN0IGdhcCA9IDY7XG4gICAgIGNvbnN0IHRvdGFsVyA9IE4gKiBjb2luU2l6ZSArIChOLTEpKmdhcDtcbiAgICAgY29uc3Qgc3RhcnRYID0gKHdpZHRoIC0gdG90YWxXKSAvIDIgKyBjb2luU2l6ZS8yO1xuXG4gICAgIFMuY3VycmVudFJlc3VsdCA9IHJlcy5tYXAoKHZhbCwgaSkgPT4gKHtcbiAgICAgICAgdmFsOiB2YWwsXG4gICAgICAgIHg6IHdpZHRoLzIsIFxuICAgICAgICB5OiA1MCxcbiAgICAgICAgdGFyZ2V0WDogc3RhcnRYICsgaSAqIChjb2luU2l6ZSArIGdhcCksIFxuICAgICAgICB0YXJnZXRZOiA2MCxcbiAgICAgICAgcjogY29pblNpemUgLyAyLFxuICAgICAgICB0OiAwXG4gICAgIH0pKTtcblxuICAgICBTLmhpc3RvcnkucHVzaChoZWFkcyk7XG4gICAgIFMuY291bnRzW2hlYWRzXSA9IChTLmNvdW50c1toZWFkc10gfHwgMCkgKyAxO1xuICAgICBTLnRvdGFsRmxpcHMrKztcbiAgICAgUy5hbmltYXRpb24gPSAxO1xuICAgICBTLmNvb2xkb3duID0gMDtcbiAgfVxuXG4gIC8vIE1hbnVhbCBGbGlwIENoZWNrXG4gIGlmIChjb2luX3NpbV9yZXNldF9wLmZsaXAgPiBTLmxhc3RGbGlwVmFsKSB7XG4gICAgIHJ1bkZsaXAoKTtcbiAgICAgUy5sYXN0RmxpcFZhbCA9IGNvaW5fc2ltX3Jlc2V0X3AuZmxpcDtcbiAgfVxuXG4gIC8vIDQuIFJFTkRFUiBMT09QXG4gIGZ1bmN0aW9uIHVwZGF0ZSgpIHtcbiAgICBjb25zdCBmb3JtID0gdmlld29mIGNvaW5fc2ltX3Jlc2V0X3A7XG4gICAgY29uc3QgY2hlY2tib3ggPSBmb3JtLnF1ZXJ5U2VsZWN0b3IoXCJpbnB1dFt0eXBlPWNoZWNrYm94XVwiKTtcbiAgICBjb25zdCBpc0F1dG8gPSBjaGVja2JveCA/IGNoZWNrYm94LmNoZWNrZWQgOiBmYWxzZTtcblxuICAgIGlmIChTLmFuaW1hdGlvbiA9PT0gMSkge1xuICAgICAgIGxldCBkb25lID0gdHJ1ZTtcbiAgICAgICBmb3IgKGxldCBjIG9mIFMuY3VycmVudFJlc3VsdCkge1xuICAgICAgICAgIGlmIChjLnQgPCAxKSB7XG4gICAgICAgICAgICAgYy50ICs9IDAuMTU7IFxuICAgICAgICAgICAgIGlmIChjLnQgPiAxKSBjLnQgPSAxO1xuICAgICAgICAgICAgIGNvbnN0IGVhc2UgPSAxIC0gTWF0aC5wb3coMSAtIGMudCwgMyk7IFxuICAgICAgICAgICAgIGMueCA9IHdpZHRoLzIgKyAoYy50YXJnZXRYIC0gd2lkdGgvMikgKiBlYXNlO1xuICAgICAgICAgICAgIGMueSA9IGMudGFyZ2V0WSAtIE1hdGguc2luKGMudCAqIE1hdGguUEkpICogMjA7IFxuICAgICAgICAgICAgIGRvbmUgPSBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgfVxuICAgICAgIGlmIChkb25lKSBTLmFuaW1hdGlvbiA9IDA7XG4gICAgfSBcbiAgICBlbHNlIGlmIChpc0F1dG8pIHtcbiAgICAgICBTLmNvb2xkb3duKys7XG4gICAgICAgaWYgKFMuY29vbGRvd24gPiA5MCkgcnVuRmxpcCgpO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGRyYXcoKSB7XG4gICAgY29uc3QgZm9ybSA9IHZpZXdvZiBjb2luX3NpbV9yZXNldF9wO1xuICAgIGNvbnN0IGNoZWNrYm94ID0gZm9ybS5xdWVyeVNlbGVjdG9yKFwiaW5wdXRbdHlwZT1jaGVja2JveF1cIik7XG4gICAgY29uc3QgaXNBdXRvID0gY2hlY2tib3ggPyBjaGVja2JveC5jaGVja2VkIDogZmFsc2U7XG5cbiAgICBjdHguZmlsbFN0eWxlID0gQkdfQ09MT1I7XG4gICAgY3R4LmZpbGxSZWN0KDAsIDAsIHdpZHRoLCBoZWlnaHQpO1xuXG4gICAgY3R4LnRleHRBbGlnbiA9IFwibGVmdFwiO1xuICAgIGN0eC5maWxsU3R5bGUgPSBURVhUX0NPTE9SO1xuICAgIGN0eC5mb250ID0gXCJib2xkIDE0cHggc2Fucy1zZXJpZlwiO1xuICAgIGN0eC5maWxsVGV4dChgTOG6p24gdGjhu6kgJHtTLnRvdGFsRmxpcHN9YCwgMjAsIDMwKTtcbiAgICBcbiAgICBpZiAoaXNBdXRvKSB7XG4gICAgICAgY3R4LmZpbGxTdHlsZSA9IFwiIzI3YWU2MFwiO1xuICAgICAgIGN0eC5maWxsVGV4dChcIuKXjyBU4buxIMSR4buZbmdcIiwgMTUwLCAzMCk7XG4gICAgfVxuICAgIFxuICAgIGlmIChTLmN1cnJlbnRSZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgIGNvbnN0IGhDb3VudCA9IFMuY3VycmVudFJlc3VsdC5maWx0ZXIoYyA9PiBjLnZhbD09PTEpLmxlbmd0aDtcbiAgICAgICBjdHgudGV4dEFsaWduID0gXCJyaWdodFwiO1xuICAgICAgIGN0eC5maWxsU3R5bGUgPSBURVhUX0NPTE9SO1xuICAgICAgIGN0eC5maWxsVGV4dChgTeG6t3Qgbmfhu61hOiAke2hDb3VudH0gLyAke059YCwgd2lkdGggLSAyMCwgMzApO1xuICAgIH1cblxuICAgIGZvciAobGV0IGMgb2YgUy5jdXJyZW50UmVzdWx0KSB7XG4gICAgICAgY3R4LmJlZ2luUGF0aCgpO1xuICAgICAgIGN0eC5hcmMoYy54LCBjLnksIGMuciwgMCwgTWF0aC5QSSoyKTtcbiAgICAgICBjdHguZmlsbFN0eWxlID0gYy52YWwgPT09IDEgPyBIRUFEX0NPTE9SIDogVEFJTF9DT0xPUjtcbiAgICAgICBjdHguZmlsbCgpO1xuICAgICAgIGN0eC5saW5lV2lkdGggPSAyO1xuICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGMudmFsID09PSAxID8gSEVBRF9CT1JERVIgOiBUQUlMX0JPUkRFUjtcbiAgICAgICBjdHguc3Ryb2tlKCk7XG4gICAgICAgY3R4LmZpbGxTdHlsZSA9IFwid2hpdGVcIjtcbiAgICAgICBjdHgudGV4dEFsaWduID0gXCJjZW50ZXJcIjtcbiAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gXCJtaWRkbGVcIjtcbiAgICAgICBjdHguZm9udCA9IGBib2xkICR7Yy5yfXB4IHNhbnMtc2VyaWZgO1xuICAgICAgIGN0eC5maWxsVGV4dChjLnZhbCA9PT0gMSA/IFwiTlwiIDogXCJTXCIsIGMueCwgYy55ICsgMSk7XG4gICAgfVxuXG4gICAgY29uc3QgY2hhcnRZID0gMzYwO1xuICAgIGNvbnN0IGNoYXJ0SCA9IDIwMDtcbiAgICBjb25zdCBjaGFydFggPSA0MDtcbiAgICBjb25zdCBjaGFydFcgPSB3aWR0aCAtIDYwO1xuICAgIFxuICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICBjdHguc3Ryb2tlU3R5bGUgPSBcIiNiZGMzYzdcIjtcbiAgICBjdHgubGluZVdpZHRoID0gMTtcbiAgICBjdHgubW92ZVRvKGNoYXJ0WCwgY2hhcnRZKTtcbiAgICBjdHgubGluZVRvKGNoYXJ0WCArIGNoYXJ0VywgY2hhcnRZKTtcbiAgICBjdHguc3Ryb2tlKCk7XG5cbiAgICBjb25zdCBiYXJXID0gY2hhcnRXIC8gKE4gKyAxKTtcbiAgICBcbiAgICAvLyBTY2FsZSBZLWF4aXMgYmFzZWQgb24gQ1VSUkVOVCBQXG4gICAgbGV0IG1heFRoZW9yZXRpY2FsUHJvYiA9IDA7XG4gICAgZm9yKGxldCBrPTA7IGs8PU47IGsrKykge1xuICAgICAgICBjb25zdCBwcm9iID0gYmlub21pYWwoaywgTiwgUCk7XG4gICAgICAgIGlmKHByb2IgPiBtYXhUaGVvcmV0aWNhbFByb2IpIG1heFRoZW9yZXRpY2FsUHJvYiA9IHByb2I7XG4gICAgfVxuICAgIGNvbnN0IFlfU0NBTEVfTUFYID0gbWF4VGhlb3JldGljYWxQcm9iICogMS4yOyBcbiAgICBcbiAgICBjb25zdCBhY3RpdmVIZWFkcyA9IFMuY3VycmVudFJlc3VsdC5maWx0ZXIoYyA9PiBjLnZhbD09PTEpLmxlbmd0aDtcblxuICAgIGZvciAobGV0IGsgPSAwOyBrIDw9IE47IGsrKykge1xuICAgICAgIGNvbnN0IGN4ID0gY2hhcnRYICsgayAqIGJhclcgKyBiYXJXLzI7XG4gICAgICAgXG4gICAgICAgLy8gVGhlb3JldGljYWwgQmFyXG4gICAgICAgY29uc3QgcHJvYiA9IGJpbm9taWFsKGssIE4sIFApO1xuICAgICAgIGNvbnN0IHRoZW9IID0gKHByb2IgLyBZX1NDQUxFX01BWCkgKiBjaGFydEg7XG4gICAgICAgXG4gICAgICAgY3R4LmZpbGxTdHlsZSA9IENIQVJUX1RIRU87XG4gICAgICAgY3R4LmZpbGxSZWN0KGN4IC0gYmFyVyowLjMsIGNoYXJ0WSAtIHRoZW9ILCBiYXJXKjAuNiwgdGhlb0gpO1xuICAgICAgIFxuICAgICAgIC8vIEFjdHVhbCBCYXJcbiAgICAgICBsZXQgb2JzZXJ2ZWRQcm9iID0gMDtcbiAgICAgICBpZiAoUy50b3RhbEZsaXBzID4gMCkgb2JzZXJ2ZWRQcm9iID0gUy5jb3VudHNba10gLyBTLnRvdGFsRmxpcHM7XG4gICAgICAgXG4gICAgICAgbGV0IGJhckggPSAob2JzZXJ2ZWRQcm9iIC8gWV9TQ0FMRV9NQVgpICogY2hhcnRIO1xuICAgICAgIGlmIChiYXJIID4gY2hhcnRIICsgMjApIGJhckggPSBjaGFydEggKyAyMDtcblxuICAgICAgIGNvbnN0IGlzQWN0aXZlID0gKFMuYW5pbWF0aW9uID09PSAwICYmIGsgPT09IGFjdGl2ZUhlYWRzICYmIFMudG90YWxGbGlwcyA+IDApO1xuICAgICAgIGN0eC5maWxsU3R5bGUgPSBpc0FjdGl2ZSA/IENIQVJUX0FDVElWRSA6IENIQVJUX0JBUjtcbiAgICAgICBjdHguZmlsbFJlY3QoY3ggLSBiYXJXKjAuMywgY2hhcnRZIC0gYmFySCwgYmFyVyowLjYsIGJhckgpO1xuICAgICAgIFxuICAgICAgIGN0eC5maWxsU3R5bGUgPSBURVhUX0NPTE9SO1xuICAgICAgIGN0eC5mb250ID0gXCIxMHB4IHNhbnMtc2VyaWZcIjtcbiAgICAgICBjdHgudGV4dEFsaWduID0gXCJjZW50ZXJcIjtcbiAgICAgICBjdHguZmlsbFRleHQoaywgY3gsIGNoYXJ0WSArIDE1KTtcbiAgICB9XG4gICAgXG4gICAgY3R4LnNhdmUoKTtcbiAgICBjdHgudHJhbnNsYXRlKDEyLCBjaGFydFkgLSBjaGFydEgvMik7XG4gICAgY3R4LnJvdGF0ZSgtTWF0aC5QSS8yKTtcbiAgICBjdHgudGV4dEFsaWduID0gXCJjZW50ZXJcIjtcbiAgICBjdHguZmlsbFN0eWxlID0gXCIjN2Y4YzhkXCI7XG4gICAgY3R4LmZpbGxUZXh0KFwiWMOhYyBzdeG6pXRcIiwgMCwgMCk7XG4gICAgY3R4LnJlc3RvcmUoKTtcbiAgfVxuXG4gIGxldCBmcmFtZUlkO1xuICBmdW5jdGlvbiB0aWNrKCkge1xuICAgIHVwZGF0ZSgpO1xuICAgIGRyYXcoKTtcbiAgICBmcmFtZUlkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spO1xuICB9XG4gIHRpY2soKTtcbiAgXG4gIHJldHVybiBPYmplY3QuYXNzaWduKGNhbnZhcywge1xuICAgIHJlbW92ZTogKCkgPT4gY2FuY2VsQW5pbWF0aW9uRnJhbWUoZnJhbWVJZClcbiAgfSk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTIiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJ2aWV3b2YgZ2FsdG9uX3NoYXJwID0gSW5wdXRzLmZvcm0oe1xuICByb3dzOiBJbnB1dHMucmFuZ2UoWzgsIDIwXSwge3ZhbHVlOiAxMCwgc3RlcDogMSwgbGFiZWw6IFwiU+G7kSBow6BuZyDEkWluaFwifSksXG4gIHNwZWVkOiBJbnB1dHMucmFuZ2UoWzAuNSwgM10sIHt2YWx1ZTogMiwgc3RlcDogMC4xLCBsYWJlbDogXCJU4buRYyDEkeG7mVwifSksXG4gIHRvdGFsOiBJbnB1dHMucmFuZ2UoWzUwLCA4MDBdLCB7dmFsdWU6IDIwMCwgc3RlcDogMTAsIGxhYmVsOiBcIlPhu5EgdmnDqm4gYmlcIn0pXG59KVxuXG52aWV3b2YgY29udHJvbF9zaGFycCA9IElucHV0cy5mb3JtKHtcbiAgc3RhcnQ6IElucHV0cy5idXR0b24oXCJC4bqvdCDEkeG6p3VcIiwge3ZhbHVlOiBudWxsLCByZWR1Y2U6ICgpID0+IFwiU1RBUlRcIn0pLFxuICBzdG9wOiBJbnB1dHMuYnV0dG9uKFwiROG7q25nXCIsIHt2YWx1ZTogbnVsbCwgcmVkdWNlOiAoKSA9PiBcIlNUT1BcIn0pXG59KVxuXG57XG4gIGNvbnN0IHJvd3MgPSBnYWx0b25fc2hhcnAucm93cztcbiAgY29uc3Qgc3BlZWQgPSBnYWx0b25fc2hhcnAuc3BlZWQ7XG4gIGNvbnN0IG1heEJhbGxzID0gZ2FsdG9uX3NoYXJwLnRvdGFsO1xuICBcbiAgLy8gMS4gRElNRU5TSU9OU1xuICAvLyBUaGUgXCJMb2dpY2FsXCIgc2l6ZSAoaG93IGJpZyBpdCBsb29rcyBvbiBzY3JlZW4pXG4gIGNvbnN0IGxvZ2ljYWxXaWR0aCA9IDM2MDtcbiAgY29uc3QgbG9naWNhbEhlaWdodCA9IDYwMDtcblxuICAvLyAyLiBISUdILURQSSBTQ0FMSU5HXG4gIC8vIFdlIGRldGVjdCB0aGUgdXNlcidzIHNjcmVlbiBkZW5zaXR5IChlLmcuLCAyLjAgZm9yIFJldGluYSlcbiAgY29uc3QgZHByID0gd2luZG93LmRldmljZVBpeGVsUmF0aW8gfHwgMTtcbiAgXG4gIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XG4gIC8vIFNldCB0aGUgXCJSZWFsXCIgc2l6ZSAocGl4ZWxzIGluIG1lbW9yeSkgaGlnaGVyXG4gIGNhbnZhcy53aWR0aCA9IGxvZ2ljYWxXaWR0aCAqIGRwcjtcbiAgY2FudmFzLmhlaWdodCA9IGxvZ2ljYWxIZWlnaHQgKiBkcHI7XG4gIC8vIFNldCB0aGUgXCJDU1NcIiBzaXplIChwaXhlbHMgb24gc2NyZWVuKSBzdGFuZGFyZFxuICBjYW52YXMuc3R5bGUud2lkdGggPSBgJHtsb2dpY2FsV2lkdGh9cHhgO1xuICBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gYCR7bG9naWNhbEhlaWdodH1weGA7XG4gIFxuICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dChcIjJkXCIpO1xuICAvLyBTY2FsZSBhbGwgZHJhd2luZyBvcGVyYXRpb25zIGF1dG9tYXRpY2FsbHlcbiAgY3R4LnNjYWxlKGRwciwgZHByKTtcblxuICAvLyAtLS0gR0VPTUVUUlkgKFVzZXMgbG9naWNhbCB1bml0cykgLS0tXG4gIGNvbnN0IHBlZ1NwYWNpbmcgPSBsb2dpY2FsV2lkdGggLyAocm93cyArIDIpO1xuICBjb25zdCByb3dIZWlnaHQgPSBwZWdTcGFjaW5nICogMC44NTsgXG4gIGNvbnN0IHN0YXJ0WSA9IDYwO1xuICBjb25zdCBwZWdSYWRpdXMgPSBwZWdTcGFjaW5nICogMC4xMjsgXG4gIGNvbnN0IGJhbGxSYWRpdXMgPSBwZWdTcGFjaW5nICogMC4yMzsgXG5cbiAgY29uc3QgZmxvb3JZID0gbG9naWNhbEhlaWdodCAtIDEwO1xuICBjb25zdCBiaW5XaWR0aCA9IHBlZ1NwYWNpbmc7XG4gIGNvbnN0IHRvdGFsQmluV2lkdGggPSAocm93cyArIDEpICogYmluV2lkdGg7XG4gIGNvbnN0IGJpbnNTdGFydFggPSAobG9naWNhbFdpZHRoIC0gdG90YWxCaW5XaWR0aCkgLyAyO1xuICBjb25zdCB3YWxsc1RvcFkgPSBzdGFydFkgKyAocm93cykgKiByb3dIZWlnaHQgKyAxMDtcblxuICAvLyBQUkUtQ09NUFVURSBCT0FSRFxuICBjb25zdCBwZWdHcmlkID0gW107IFxuICBmb3IgKGxldCByID0gMDsgciA8IHJvd3M7IHIrKykge1xuICAgIGNvbnN0IHJvd1BlZ3MgPSBbXTtcbiAgICBjb25zdCBwZWdzSW5UaGlzUm93ID0gciArIDE7XG4gICAgY29uc3Qgcm93V2lkdGggPSAocGVnc0luVGhpc1JvdyAtIDEpICogcGVnU3BhY2luZztcbiAgICBjb25zdCByb3dTdGFydFggPSAobG9naWNhbFdpZHRoIC0gcm93V2lkdGgpIC8gMjtcbiAgICBmb3IgKGxldCBwID0gMDsgcCA8IHBlZ3NJblRoaXNSb3c7IHArKykge1xuICAgICAgcm93UGVncy5wdXNoKHtcbiAgICAgICAgeDogcm93U3RhcnRYICsgcCAqIHBlZ1NwYWNpbmcsXG4gICAgICAgIHk6IHN0YXJ0WSArIHIgKiByb3dIZWlnaHRcbiAgICAgIH0pO1xuICAgIH1cbiAgICBwZWdHcmlkLnB1c2gocm93UGVncyk7XG4gIH1cblxuICAvLyBTVEFURVxuICBsZXQgYmFsbHMgPSBbXTtcbiAgbGV0IGJpbnMgPSBuZXcgQXJyYXkocm93cyArIDEpLmZpbGwoMCk7XG4gIGxldCBzcGF3bmVkQ291bnQgPSAwO1xuICBsZXQgaXNSdW5uaW5nID0gZmFsc2U7XG5cbiAgLy8gQ09OVFJPTFNcbiAgY29uc3Qgc3RhcnRCdG4gPSB2aWV3b2YgY29udHJvbF9zaGFycC5xdWVyeVNlbGVjdG9yKFwiYnV0dG9uXCIpOyBcbiAgY29uc3Qgc3RvcEJ0biA9IHZpZXdvZiBjb250cm9sX3NoYXJwLnF1ZXJ5U2VsZWN0b3JBbGwoXCJidXR0b25cIilbMV07XG5cbiAgc3RhcnRCdG4ub25jbGljayA9ICgpID0+IHtcbiAgICBiYWxscyA9IFtdO1xuICAgIGJpbnMgPSBuZXcgQXJyYXkocm93cyArIDEpLmZpbGwoMCk7XG4gICAgc3Bhd25lZENvdW50ID0gMDtcbiAgICBpc1J1bm5pbmcgPSB0cnVlO1xuICB9O1xuICBzdG9wQnRuLm9uY2xpY2sgPSAoKSA9PiB7IGlzUnVubmluZyA9IGZhbHNlOyB9O1xuXG4gIC8vIFBBVEggTE9HSUNcbiAgZnVuY3Rpb24gY3JlYXRlQmFsbCgpIHtcbiAgICBsZXQgY3VycmVudEluZCA9IDA7IFxuICAgIGxldCBwYXRoID0gW107XG4gICAgcGF0aC5wdXNoKHsgeDogbG9naWNhbFdpZHRoIC8gMiwgeTogc3RhcnRZIC0gMjAgfSk7XG5cbiAgICBmb3IgKGxldCByID0gMDsgciA8IHJvd3M7IHIrKykge1xuICAgICAgIGNvbnN0IHBlZyA9IHBlZ0dyaWRbcl1bY3VycmVudEluZF07XG4gICAgICAgcGF0aC5wdXNoKHsgeDogcGVnLngsIHk6IHBlZy55IC0gcGVnUmFkaXVzIC0gYmFsbFJhZGl1cyB9KTtcbiAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkgY3VycmVudEluZCsrOyBcbiAgICB9XG5cbiAgICBjb25zdCBiaW5YID0gYmluc1N0YXJ0WCArIGN1cnJlbnRJbmQgKiBiaW5XaWR0aCArIGJpbldpZHRoLzI7XG4gICAgcGF0aC5wdXNoKHsgeDogYmluWCwgeTogd2FsbHNUb3BZIH0pO1xuICAgIHBhdGgucHVzaCh7IHg6IGJpblgsIHk6IGZsb29yWSAtIGJhbGxSYWRpdXMsIGlzRmxvb3I6IHRydWUsIGJpbkluZGV4OiBjdXJyZW50SW5kIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHBhdGg6IHBhdGgsXG4gICAgICBzZWdtZW50OiAwLCB0OiAwLCBhY3RpdmU6IHRydWUsXG4gICAgICB4OiBwYXRoWzBdLngsIHk6IHBhdGhbMF0ueVxuICAgIH07XG4gIH1cblxuICBmdW5jdGlvbiBzcGF3bkJhbGwoKSB7XG4gICAgaWYgKCFpc1J1bm5pbmcpIHJldHVybjtcbiAgICBpZiAoc3Bhd25lZENvdW50ID49IG1heEJhbGxzKSByZXR1cm47XG4gICAgXG4gICAgY29uc3QgY2VudGVyQmluSWR4ID0gTWF0aC5mbG9vcihyb3dzIC8gMik7XG4gICAgY29uc3QgbWF4Q2FwYWNpdHkgPSAoZmxvb3JZIC0gd2FsbHNUb3BZKSAvIChiYWxsUmFkaXVzICogMC42KTsgXG4gICAgaWYgKGJpbnNbY2VudGVyQmluSWR4XSA+PSBtYXhDYXBhY2l0eSkgcmV0dXJuO1xuXG4gICAgYmFsbHMucHVzaChjcmVhdGVCYWxsKCkpO1xuICAgIHNwYXduZWRDb3VudCsrO1xuICB9XG5cbiAgZnVuY3Rpb24gdXBkYXRlKGR0KSB7XG4gICAgY29uc3Qgc3Bhd25SYXRlID0gMC4xNSAvIHNwZWVkOyBcbiAgICBpZiAoaXNSdW5uaW5nICYmIE1hdGgucmFuZG9tKCkgPCBkdCAvIHNwYXduUmF0ZSkgc3Bhd25CYWxsKCk7XG5cbiAgICBmb3IgKGxldCBiIG9mIGJhbGxzKSB7XG4gICAgICBpZiAoIWIuYWN0aXZlKSBjb250aW51ZTtcbiAgICAgIGlmICghaXNSdW5uaW5nKSBjb250aW51ZTsgXG5cbiAgICAgIGNvbnN0IG1vdmVTcGVlZCA9IDMuNSAqIHNwZWVkICogZHQ7IFxuICAgICAgYi50ICs9IG1vdmVTcGVlZDtcblxuICAgICAgaWYgKGIudCA+PSAxKSB7XG4gICAgICAgIGIudCA9IDA7XG4gICAgICAgIGIuc2VnbWVudCsrO1xuICAgICAgICBpZiAoYi5zZWdtZW50ID49IGIucGF0aC5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgIGIuYWN0aXZlID0gZmFsc2U7XG4gICAgICAgICAgIGNvbnN0IGZpbmFsUHQgPSBiLnBhdGhbYi5wYXRoLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICBiaW5zW2ZpbmFsUHQuYmluSW5kZXhdKys7XG4gICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHAwID0gYi5wYXRoW2Iuc2VnbWVudF07XG4gICAgICBjb25zdCBwMSA9IGIucGF0aFtiLnNlZ21lbnQgKyAxXTtcbiAgICAgIFxuICAgICAgYi54ID0gcDAueCArIChwMS54IC0gcDAueCkgKiBiLnQ7XG4gICAgICBpZiAocDEuaXNGbG9vcikge1xuICAgICAgICAgYi55ID0gcDAueSArIChwMS55IC0gcDAueSkgKiAoYi50ICogYi50KTsgXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAgYi55ID0gcDAueSArIChwMS55IC0gcDAueSkgKiAoYi50ICogYi50KTsgXG4gICAgICB9XG4gICAgfVxuICAgIGJhbGxzID0gYmFsbHMuZmlsdGVyKGIgPT4gYi5hY3RpdmUpO1xuICB9XG5cbiAgZnVuY3Rpb24gZHJhdygpIHtcbiAgICAvLyBDbGVhciB0aGUgZnVsbCBsb2dpY2FsIGFyZWFcbiAgICBjdHguZmlsbFN0eWxlID0gXCIjRThFMEM1XCI7XG4gICAgY3R4LmZpbGxSZWN0KDAsIDAsIGxvZ2ljYWxXaWR0aCwgbG9naWNhbEhlaWdodCk7XG5cbiAgICAvLyBQZWdzXG4gICAgY3R4LmZpbGxTdHlsZSA9IFwiIzY2NlwiO1xuICAgIGZvciAobGV0IHJvdyBvZiBwZWdHcmlkKSB7XG4gICAgICBmb3IgKGxldCBwIG9mIHJvdykge1xuICAgICAgICBjdHguYmVnaW5QYXRoKCk7XG4gICAgICAgIGN0eC5hcmMocC54LCBwLnksIHBlZ1JhZGl1cywgMCwgTWF0aC5QSSoyKTtcbiAgICAgICAgY3R4LmZpbGwoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBXYWxsc1xuICAgIGN0eC5zdHJva2VTdHlsZSA9IFwiIzk5ODg2NlwiO1xuICAgIGN0eC5saW5lV2lkdGggPSAxO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IHJvd3MgKyAxOyBpKyspIHtcbiAgICAgIGNvbnN0IHggPSBiaW5zU3RhcnRYICsgaSAqIGJpbldpZHRoO1xuICAgICAgY3R4LmJlZ2luUGF0aCgpO1xuICAgICAgY3R4Lm1vdmVUbyh4LCB3YWxsc1RvcFkpO1xuICAgICAgY3R4LmxpbmVUbyh4LCBsb2dpY2FsSGVpZ2h0KTtcbiAgICAgIGN0eC5zdHJva2UoKTtcbiAgICB9XG5cbiAgICAvLyBBY3RpdmUgQmFsbHNcbiAgICBjdHguZmlsbFN0eWxlID0gXCIjMDAzM0NDXCI7XG4gICAgZm9yIChsZXQgYiBvZiBiYWxscykge1xuICAgICAgY3R4LmJlZ2luUGF0aCgpO1xuICAgICAgY3R4LmFyYyhiLngsIGIueSwgYmFsbFJhZGl1cywgMCwgTWF0aC5QSSoyKTtcbiAgICAgIGN0eC5maWxsKCk7XG4gICAgfVxuXG4gICAgLy8gU3RhY2tlZCBCYWxsc1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmlucy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgY291bnQgPSBiaW5zW2ldO1xuICAgICAgY29uc3QgY3ggPSBiaW5zU3RhcnRYICsgaSAqIGJpbldpZHRoICsgYmluV2lkdGgvMjtcbiAgICAgIGN0eC5zdHJva2VTdHlsZSA9IFwiIzRkNzlmZlwiO1xuICAgICAgY3R4LmxpbmVXaWR0aCA9IDAuNTtcblxuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBjb3VudDsgaisrKSB7XG4gICAgICAgIGNvbnN0IGN5ID0gZmxvb3JZIC0gaiAqIChiYWxsUmFkaXVzICogMC42KTsgXG4gICAgICAgIGlmIChjeSA8IHdhbGxzVG9wWSkgYnJlYWs7XG4gICAgICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICAgICAgY3R4LmFyYyhjeCwgY3ksIGJhbGxSYWRpdXMsIDAsIE1hdGguUEkqMik7XG4gICAgICAgIGN0eC5maWxsU3R5bGUgPSBcIiMwMDMzQ0NcIjtcbiAgICAgICAgY3R4LmZpbGwoKTtcbiAgICAgICAgY3R4LnN0cm9rZSgpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvLyBTdGF0dXMgVGV4dFxuICAgIGN0eC5maWxsU3R5bGUgPSBcIiM0NDRcIjtcbiAgICBjdHguZm9udCA9IFwiYm9sZCAxNHB4IHNhbnMtc2VyaWZcIjtcbiAgICBjdHguZmlsbFRleHQoYFPhu5EgdmnDqm4gYmk6ICR7c3Bhd25lZENvdW50fSAvICR7bWF4QmFsbHN9YCwgMTAsIDI1KTtcbiAgfVxuXG4gIGxldCBsYXN0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICBsZXQgZnJhbWVJZDtcbiAgZnVuY3Rpb24gdGljayhub3cpIHtcbiAgICBjb25zdCBkdCA9IE1hdGgubWluKChub3cgLSBsYXN0VGltZSkgLyAxMDAwLCAwLjEpO1xuICAgIGxhc3RUaW1lID0gbm93O1xuICAgIHVwZGF0ZShkdCk7XG4gICAgZHJhdygpO1xuICAgIGZyYW1lSWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGljayk7XG4gIH1cbiAgXG4gIGRyYXcoKTtcbiAgdGljayhsYXN0VGltZSk7XG4gIFxuICByZXR1cm4gT2JqZWN0LmFzc2lnbihjYW52YXMsIHtcbiAgICByZW1vdmU6ICgpID0+IGNhbmNlbEFuaW1hdGlvbkZyYW1lKGZyYW1lSWQpXG4gIH0pO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0zIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoidmlld29mIGFjZV9zaW1fZml4ZWQgPSBJbnB1dHMuZm9ybSh7XG4gIGRyYXc6IElucHV0cy5idXR0b24oXCJSw7p0IDEwIGzDoVwiKSxcbiAgYXV0bzogSW5wdXRzLnRvZ2dsZSh7bGFiZWw6IFwiVOG7sSDEkeG7mW5nXCIsIHZhbHVlOiBmYWxzZX0pLFxuICByZXNldDogSW5wdXRzLmJ1dHRvbihcIkzhuqFpIHThu6sgxJHhuqd1XCIpXG59KVxuXG57XG4gIC8vIDEuIFNFVFVQXG4gIGNvbnN0IHdpZHRoID0gNDAwO1xuICBjb25zdCBoZWlnaHQgPSA0MDA7XG4gIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XG4gIGNvbnN0IGRwciA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvIHx8IDE7XG4gIGNhbnZhcy53aWR0aCA9IHdpZHRoICogZHByO1xuICBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0ICogZHByO1xuICBjYW52YXMuc3R5bGUud2lkdGggPSBgJHt3aWR0aH1weGA7XG4gIGNhbnZhcy5zdHlsZS5oZWlnaHQgPSBgJHtoZWlnaHR9cHhgO1xuICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dChcIjJkXCIsIHsgYWxwaGE6IGZhbHNlIH0pO1xuICBjdHguc2NhbGUoZHByLCBkcHIpO1xuXG4gIC8vIENPTE9SU1xuICBjb25zdCBCR19DT0xPUiA9IFwiI2Y0ZjZmOFwiOyBcbiAgY29uc3QgVEVYVF9DT0xPUiA9IFwiIzMzMzMzM1wiO1xuICBjb25zdCBBQ0VfQ09MT1IgPSBcIiNkMzU0MDBcIjsgXG4gIGNvbnN0IEFDRV9CRyA9IFwiI2ZmZmJlNlwiOyBcbiAgY29uc3QgQ0FSRF9CR19TVEQgPSBcIiNmZmZmZmZcIjsgXG4gIGNvbnN0IENBUkRfQk9SREVSID0gXCIjY2NjY2NjXCI7IFxuICBjb25zdCBDQVJEX1JFRCA9IFwiI2U3NGMzY1wiO1xuICBjb25zdCBDQVJEX0JMQUNLID0gXCIjMmMzZTUwXCI7XG4gIFxuICBjb25zdCBDSEFSVF9USEVPID0gXCJyZ2JhKDAsIDAsIDAsIDAuMDUpXCI7XG4gIGNvbnN0IENIQVJUX0FDVFVBTCA9IFwiIzAwOTY4OFwiOyBcbiAgY29uc3QgQ0hBUlRfQUNUSVZFID0gXCIjMDA3OTZiXCI7IFxuXG4gIC8vIE1BVEhcbiAgZnVuY3Rpb24gaHlwZXJnZW9tKGssIE4sIEssIG4pIHtcbiAgICAgZnVuY3Rpb24gbkNyKG4sIHIpIHtcbiAgICAgICAgaWYgKHIgPCAwIHx8IHIgPiBuKSByZXR1cm4gMDtcbiAgICAgICAgbGV0IHJlcyA9IDE7XG4gICAgICAgIGZvcihsZXQgaT0wOyBpPHI7IGkrKykgcmVzID0gcmVzICogKG4gLSBpKSAvIChpICsgMSk7XG4gICAgICAgIHJldHVybiByZXM7XG4gICAgIH1cbiAgICAgcmV0dXJuIChuQ3IoSywgaykgKiBuQ3IoTiAtIEssIG4gLSBrKSkgLyBuQ3IoTiwgbik7XG4gIH1cbiAgY29uc3QgVEhFT1JFVElDQUwgPSBbXTtcbiAgZm9yKGxldCBrPTA7IGs8PTQ7IGsrKykgVEhFT1JFVElDQUxba10gPSBoeXBlcmdlb20oaywgNTIsIDQsIDEwKTtcblxuICAvLyAyLiBTVEFURSAoUGVyc2lzdGVudClcbiAgaWYgKCF0aGlzLnN0YXRlRml4ZWQpIHtcbiAgICB0aGlzLnN0YXRlRml4ZWQgPSB7XG4gICAgICAgY291bnRzOiBbMCwgMCwgMCwgMCwgMF0sIFxuICAgICAgIHRvdGFsRGVhbHM6IDAsXG4gICAgICAgbGFzdEhhbmQ6IFtdLFxuICAgICAgIGFuaW1hdGlvbjogMCwgXG4gICAgICAgY29vbGRvd246IDAsXG4gICAgICAgLy8gVFJBQ0tFUlMgdG8gZGV0ZWN0IHJlYWwgY2xpY2tzXG4gICAgICAgbGFzdERyYXdWYWw6IGFjZV9zaW1fZml4ZWQuZHJhdyxcbiAgICAgICBsYXN0UmVzZXRWYWw6IGFjZV9zaW1fZml4ZWQucmVzZXRcbiAgICB9O1xuICB9XG4gIGNvbnN0IFMgPSB0aGlzLnN0YXRlRml4ZWQ7XG5cbiAgLy8gMy4gTE9HSUNcbiAgY29uc3QgU1VJVFMgPSBbXCLimaBcIiwgXCLimaVcIiwgXCLimaNcIiwgXCLimaZcIl07XG4gIGNvbnN0IFJBTktTID0gW1wiMlwiLFwiM1wiLFwiNFwiLFwiNVwiLFwiNlwiLFwiN1wiLFwiOFwiLFwiOVwiLFwiMTBcIixcIkpcIixcIlFcIixcIktcIixcIkFcIl07XG4gIGNvbnN0IENBUkRfVyA9IDMwO1xuICBjb25zdCBDQVJEX0ggPSA0NTtcblxuICBmdW5jdGlvbiBydW5EZWFsKCkge1xuICAgIGxldCBkZWNrID0gW107XG4gICAgZm9yKGxldCBzIG9mIFNVSVRTKSB7XG4gICAgICBmb3IobGV0IHIgb2YgUkFOS1MpIHtcbiAgICAgICAgZGVjay5wdXNoKHsgcmFuazogciwgc3VpdDogcywgaXNBY2U6IHIgPT09IFwiQVwiIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IobGV0IGk9ZGVjay5sZW5ndGgtMTsgaT4wOyBpLS0pIHtcbiAgICAgICBjb25zdCBqID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKGkrMSkpO1xuICAgICAgIFtkZWNrW2ldLCBkZWNrW2pdXSA9IFtkZWNrW2pdLCBkZWNrW2ldXTtcbiAgICB9XG4gICAgXG4gICAgY29uc3QgaGFuZCA9IGRlY2suc2xpY2UoMCwgMTApO1xuICAgIGNvbnN0IGFjZUNvdW50ID0gaGFuZC5maWx0ZXIoYyA9PiBjLmlzQWNlKS5sZW5ndGg7XG4gICAgXG4gICAgUy5jb3VudHNbYWNlQ291bnRdKys7XG4gICAgUy50b3RhbERlYWxzKys7XG4gICAgXG4gICAgY29uc3Qgc3RhcnRYID0gKHdpZHRoIC0gKDUgKiAoQ0FSRF9XICsgOCkpKSAvIDIgKyA0O1xuICAgIFMubGFzdEhhbmQgPSBoYW5kLm1hcCgoYywgaSkgPT4ge1xuICAgICAgIGNvbnN0IHJvdyA9IE1hdGguZmxvb3IoaSAvIDUpO1xuICAgICAgIGNvbnN0IGNvbCA9IGkgJSA1O1xuICAgICAgIHJldHVybiB7XG4gICAgICAgICAuLi5jLFxuICAgICAgICAgeDogMjAsIHk6IDIwLCBcbiAgICAgICAgIHRhcmdldFg6IHN0YXJ0WCArIGNvbCAqIChDQVJEX1cgKyA4KSxcbiAgICAgICAgIHRhcmdldFk6IDcwICsgcm93ICogKENBUkRfSCArIDEyKSxcbiAgICAgICAgIHQ6IDBcbiAgICAgICB9O1xuICAgIH0pO1xuICAgIFMuYW5pbWF0aW9uID0gMTtcbiAgICBTLmNvb2xkb3duID0gMDsgXG4gIH1cblxuICAvLyAtLS0gQlVUVE9OIEhBTkRMSU5HIChUaGUgRml4KSAtLS1cbiAgXG4gIC8vIDEuIERldGVjdCBSRVNFVCBDbGlja1xuICBpZiAoYWNlX3NpbV9maXhlZC5yZXNldCA+IFMubGFzdFJlc2V0VmFsKSB7XG4gICAgIFMuY291bnRzID0gWzAsMCwwLDAsMF07XG4gICAgIFMudG90YWxEZWFscyA9IDA7XG4gICAgIFMubGFzdEhhbmQgPSBbXTtcbiAgICAgUy5hbmltYXRpb24gPSAwO1xuICAgICAvLyBVcGRhdGUgdHJhY2tlciBzbyB3ZSBkb24ndCByZXNldCBhZ2FpbiB1bnRpbCBuZXh0IGNsaWNrXG4gICAgIFMubGFzdFJlc2V0VmFsID0gYWNlX3NpbV9maXhlZC5yZXNldDtcbiAgfVxuXG4gIC8vIDIuIERldGVjdCBEUkFXIENsaWNrXG4gIC8vIFdlIG9ubHkgcnVuIGRlYWwgaWYgdGhlIGJ1dHRvbiBjb3VudCBpcyBISUdIRVIgdGhhbiBsYXN0IHRpbWVcbiAgaWYgKGFjZV9zaW1fZml4ZWQuZHJhdyA+IFMubGFzdERyYXdWYWwpIHtcbiAgICAgcnVuRGVhbCgpO1xuICAgICBTLmxhc3REcmF3VmFsID0gYWNlX3NpbV9maXhlZC5kcmF3O1xuICB9XG5cbiAgLy8gNC4gUkVOREVSIExPT1BcbiAgZnVuY3Rpb24gdXBkYXRlKCkge1xuICAgIGNvbnN0IGZvcm0gPSB2aWV3b2YgYWNlX3NpbV9maXhlZDtcbiAgICBjb25zdCBjaGVja2JveCA9IGZvcm0ucXVlcnlTZWxlY3RvcihcImlucHV0W3R5cGU9Y2hlY2tib3hdXCIpO1xuICAgIGNvbnN0IGlzQXV0b1J1bm5pbmcgPSBjaGVja2JveCA/IGNoZWNrYm94LmNoZWNrZWQgOiBmYWxzZTtcblxuICAgIGlmIChTLmFuaW1hdGlvbiA9PT0gMSkge1xuICAgICAgIGxldCBkb25lID0gdHJ1ZTtcbiAgICAgICBmb3IgKGxldCBjIG9mIFMubGFzdEhhbmQpIHtcbiAgICAgICAgICBpZiAoYy50IDwgMSkge1xuICAgICAgICAgICAgIGMudCArPSAwLjA4OyBcbiAgICAgICAgICAgICBpZiAoYy50ID4gMSkgYy50ID0gMTtcbiAgICAgICAgICAgICBjLnggPSAyMCArIChjLnRhcmdldFggLSAyMCkgKiBjLnQ7XG4gICAgICAgICAgICAgYy55ID0gMjAgKyAoYy50YXJnZXRZIC0gMjApICogYy50O1xuICAgICAgICAgICAgIGRvbmUgPSBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgfVxuICAgICAgIGlmIChkb25lKSBTLmFuaW1hdGlvbiA9IDA7XG4gICAgfSBlbHNlIGlmIChpc0F1dG9SdW5uaW5nKSB7XG4gICAgICAgUy5jb29sZG93bisrO1xuICAgICAgIGlmIChTLmNvb2xkb3duID4gMTAwKSBydW5EZWFsKCk7IFxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGRyYXcoKSB7XG4gICAgY29uc3QgZm9ybSA9IHZpZXdvZiBhY2Vfc2ltX2ZpeGVkO1xuICAgIGNvbnN0IGNoZWNrYm94ID0gZm9ybS5xdWVyeVNlbGVjdG9yKFwiaW5wdXRbdHlwZT1jaGVja2JveF1cIik7XG4gICAgY29uc3QgaXNBdXRvUnVubmluZyA9IGNoZWNrYm94ID8gY2hlY2tib3guY2hlY2tlZCA6IGZhbHNlO1xuXG4gICAgY3R4LmZpbGxTdHlsZSA9IEJHX0NPTE9SO1xuICAgIGN0eC5maWxsUmVjdCgwLCAwLCB3aWR0aCwgaGVpZ2h0KTtcblxuICAgIC8vIFRleHRcbiAgICBjdHgudGV4dEFsaWduID0gXCJsZWZ0XCI7XG4gICAgY3R4LmZpbGxTdHlsZSA9IFRFWFRfQ09MT1I7XG4gICAgY3R4LmZvbnQgPSBcIjE0cHggc2Fucy1zZXJpZlwiO1xuICAgIGN0eC5maWxsVGV4dChgTOG6p24gcsO6dCB0aOG7qTogJHtTLnRvdGFsRGVhbHN9YCwgNjAsIDMwKTtcbiAgICBcbiAgICBpZiAoaXNBdXRvUnVubmluZykge1xuICAgICAgICBjdHguZmlsbFN0eWxlID0gQ0hBUlRfQUNUVUFMO1xuICAgICAgICBjdHguZmlsbFRleHQoXCLil48gVOG7sSDEkeG7mW5nXCIsIDYwLCA1MCk7XG4gICAgfSBlbHNlIGlmIChTLmxhc3RIYW5kLmxlbmd0aCA+IDApIHtcbiAgICAgICBjb25zdCBhY2VzID0gUy5sYXN0SGFuZC5maWx0ZXIoYz0+Yy5pc0FjZSkubGVuZ3RoO1xuICAgICAgIGN0eC5maWxsU3R5bGUgPSBBQ0VfQ09MT1I7XG4gICAgICAgY3R4LmZpbGxUZXh0KGBL4bq/dCBxdeG6ozogJHthY2VzfSBsw6EgQWAsIDYwLCA1MCk7XG4gICAgfVxuXG4gICAgLy8gRGVja1xuICAgIGN0eC5maWxsU3R5bGUgPSBDQVJEX0JHX1NURDtcbiAgICBjdHguc3Ryb2tlU3R5bGUgPSBDQVJEX0JPUkRFUjtcbiAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHtcbiAgICAgIGN0eC5maWxsUmVjdCgyMC1pLCAyMC1pLCBDQVJEX1csIENBUkRfSCk7XG4gICAgICBjdHguc3Ryb2tlUmVjdCgyMC1pLCAyMC1pLCBDQVJEX1csIENBUkRfSCk7XG4gICAgfVxuXG4gICAgLy8gSGFuZFxuICAgIGZvciAobGV0IGMgb2YgUy5sYXN0SGFuZCkge1xuICAgICAgICBjdHguZmlsbFN0eWxlID0gYy5pc0FjZSA/IEFDRV9CRyA6IENBUkRfQkdfU1REO1xuICAgICAgICBjdHguZmlsbFJlY3QoYy54LCBjLnksIENBUkRfVywgQ0FSRF9IKTtcbiAgICAgICAgXG4gICAgICAgIGN0eC5saW5lV2lkdGggPSAxO1xuICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBjLmlzQWNlID8gQUNFX0NPTE9SIDogQ0FSRF9CT1JERVI7XG4gICAgICAgIGN0eC5zdHJva2VSZWN0KGMueCwgYy55LCBDQVJEX1csIENBUkRfSCk7XG5cbiAgICAgICAgY29uc3QgaXNSZWQgPSAoYy5zdWl0ID09PSBcIuKZpVwiIHx8IGMuc3VpdCA9PT0gXCLimaZcIik7XG4gICAgICAgIGN0eC5maWxsU3R5bGUgPSBjLmlzQWNlID8gQUNFX0NPTE9SIDogKGlzUmVkID8gQ0FSRF9SRUQgOiBDQVJEX0JMQUNLKTtcbiAgICAgICAgXG4gICAgICAgIGN0eC50ZXh0QWxpZ24gPSBcImxlZnRcIjsgY3R4LnRleHRCYXNlbGluZSA9IFwidG9wXCI7XG4gICAgICAgIGN0eC5mb250ID0gXCJib2xkIDE0cHggc2Fucy1zZXJpZlwiO1xuICAgICAgICBjdHguZmlsbFRleHQoYy5yYW5rLCBjLnggKyAzLCBjLnkgKyA0KTtcbiAgICAgICAgY3R4LmZvbnQgPSBcIjE2cHggc2Fucy1zZXJpZlwiO1xuICAgICAgICBjdHguZmlsbFRleHQoYy5zdWl0LCBjLnggKyAzLCBjLnkgKyAyMCk7XG4gICAgfVxuXG4gICAgLy8gQ2hhcnRcbiAgICBjb25zdCBjaGFydFkgPSAzNDA7IFxuICAgIGNvbnN0IGNoYXJ0SCA9IDgwOyBcbiAgICBjb25zdCBjaGFydFggPSA0MDtcbiAgICBjb25zdCBiYXJXID0gNDA7XG4gICAgY29uc3QgZ2FwID0gMjU7XG4gICAgXG4gICAgY3R4LmJlZ2luUGF0aCgpO1xuICAgIGN0eC5zdHJva2VTdHlsZSA9IFwiIzk5OTk5OVwiO1xuICAgIGN0eC5saW5lV2lkdGggPSAxO1xuICAgIGN0eC5tb3ZlVG8oY2hhcnRYIC0gMTAsIGNoYXJ0WSk7XG4gICAgY3R4LmxpbmVUbyh3aWR0aCAtIDIwLCBjaGFydFkpO1xuICAgIGN0eC5zdHJva2UoKTtcbiAgICBcbiAgICBjdHguZmlsbFN0eWxlID0gVEVYVF9DT0xPUjtcbiAgICBjdHguZm9udCA9IFwiMTJweCBzYW5zLXNlcmlmXCI7XG4gICAgY3R4LnRleHRBbGlnbiA9IFwiY2VudGVyXCI7XG4gICAgY3R4LmZpbGxUZXh0KFwiU+G7kSBsw6EgQSByw7p0IMSRxrDhu6NjIChrKVwiLCB3aWR0aC8yICsgMTAsIGNoYXJ0WSArIDM1KTtcblxuICAgIGNvbnN0IGFjdGl2ZUFjZXMgPSBTLmxhc3RIYW5kLmZpbHRlcihjPT5jLmlzQWNlKS5sZW5ndGg7XG5cbiAgICBmb3IgKGxldCBrID0gMDsgayA8PSA0OyBrKyspIHtcbiAgICAgICBjb25zdCB4ID0gY2hhcnRYICsgayAqIChiYXJXICsgZ2FwKTtcbiAgICAgICBcbiAgICAgICBjb25zdCBwcm9iID0gVEhFT1JFVElDQUxba107XG4gICAgICAgY29uc3Qgc2NhbGVIID0gY2hhcnRIIC8gMC41O1xuICAgICAgIGNvbnN0IHRoZW9IID0gcHJvYiAqIHNjYWxlSDtcbiAgICAgICBjdHguZmlsbFN0eWxlID0gQ0hBUlRfVEhFTztcbiAgICAgICBjdHguZmlsbFJlY3QoeCwgY2hhcnRZIC0gdGhlb0gsIGJhclcsIHRoZW9IKTtcbiAgICAgICBcbiAgICAgICBsZXQgY291bnQgPSBTLmNvdW50c1trXTtcbiAgICAgICBsZXQgcGN0ID0gUy50b3RhbERlYWxzID4gMCA/IGNvdW50IC8gUy50b3RhbERlYWxzIDogMDtcbiAgICAgICBsZXQgYmFySCA9IHBjdCAqIHNjYWxlSDtcbiAgICAgICBcbiAgICAgICBjb25zdCBpc0FjdGl2ZSA9IChTLmFuaW1hdGlvbiA9PT0gMCAmJiBTLnRvdGFsRGVhbHMgPiAwICYmIGsgPT09IGFjdGl2ZUFjZXMpO1xuICAgICAgIGN0eC5maWxsU3R5bGUgPSBpc0FjdGl2ZSA/IENIQVJUX0FDVElWRSA6IENIQVJUX0FDVFVBTDtcbiAgICAgICBjdHguZmlsbFJlY3QoeCwgY2hhcnRZIC0gYmFySCwgYmFyVywgYmFySCk7XG4gICAgICAgXG4gICAgICAgY3R4LmZpbGxTdHlsZSA9IFRFWFRfQ09MT1I7XG4gICAgICAgY3R4LmZvbnQgPSBcImJvbGQgMTJweCBzYW5zLXNlcmlmXCI7XG4gICAgICAgY3R4LmZpbGxUZXh0KGssIHggKyBiYXJXLzIsIGNoYXJ0WSArIDE1KTtcbiAgICAgICBcbiAgICAgICBpZiAocGN0ID4gMCkge1xuICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBpc0FjdGl2ZSA/IENIQVJUX0FDVElWRSA6IFRFWFRfQ09MT1I7XG4gICAgICAgICAgY3R4LmZvbnQgPSBcIjEwcHggc2Fucy1zZXJpZlwiO1xuICAgICAgICAgIGNvbnN0IGxhYmVsWSA9IGJhckggPiAyMCA/IGNoYXJ0WSAtIGJhckggKyAxMiA6IGNoYXJ0WSAtIGJhckggLSA1O1xuICAgICAgICAgIGlmIChpc0FjdGl2ZSAmJiBiYXJIID4gMjApIGN0eC5maWxsU3R5bGUgPSBcIiNmZmZmZmZcIjtcbiAgICAgICAgICBjdHguZmlsbFRleHQoKHBjdCoxMDApLnRvRml4ZWQoMCkrXCIlXCIsIHgrYmFyVy8yLCBsYWJlbFkpO1xuICAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsZXQgZnJhbWVJZDtcbiAgZnVuY3Rpb24gdGljaygpIHtcbiAgICB1cGRhdGUoKTtcbiAgICBkcmF3KCk7XG4gICAgZnJhbWVJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKTtcbiAgfVxuICB0aWNrKCk7XG4gIFxuICByZXR1cm4gT2JqZWN0LmFzc2lnbihjYW52YXMsIHtcbiAgICByZW1vdmU6ICgpID0+IGNhbmNlbEFuaW1hdGlvbkZyYW1lKGZyYW1lSWQpXG4gIH0pO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdjb2luX3NpbV9yZXNldF9wJykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ2dhbHRvbl9zaGFycCcpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdjb250cm9sX3NoYXJwJykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ2FjZV9zaW1fZml4ZWQnKSJ9XX0=
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../..";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "thinhong/s4bvn";
    script.dataset.repoId = "R_kgDOQtVYcQ";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOQtVYcc4C00o0";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./distr-shape.html" class="pagination-link" aria-label="Hình dạng phân phối">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Hình dạng phân phối</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="Tài liệu tham khảo">
        <span class="nav-page-text">Tài liệu tham khảo</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>